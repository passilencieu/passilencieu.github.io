<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="2575.6">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; font: 12.0px Helvetica; min-height: 14.0px}
    span.s1 {font: 12.0px Courier}
    span.s2 {font: 12.0px 'Apple Color Emoji'}
  </style>
</head>
<body>
<p class="p1">&lt;!DOCTYPE html&gt;&lt;html&gt;&lt;head&gt;&lt;meta charset="utf-8"&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;style&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>body {</p>
<p class="p1"><span class="Apple-converted-space">    </span>background: transparent !important;</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>.text-shadow {</p>
<p class="p1"><span class="Apple-converted-space">    </span>text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000, -2px -2px 0 #000, 2px -2px 0 #000, -2px 2px 0 #000, 2px 2px 0 #000, 0 0 4px #000, 0 0 1px #000, 0 0 12px #000;</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>.info-icon {</p>
<p class="p1"><span class="Apple-converted-space">    </span>width: 30px;</p>
<p class="p1"><span class="Apple-converted-space">    </span>text-align: center;</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>.weather-icon {</p>
<p class="p1"><span class="Apple-converted-space">    </span>position: relative;</p>
<p class="p1"><span class="Apple-converted-space">    </span>display: inline-block;</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>.weather-icon-main {</p>
<p class="p1"><span class="Apple-converted-space">    </span>color: white;</p>
<p class="p1"><span class="Apple-converted-space">    </span>text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000, -2px -2px 0 #000, 2px -2px 0 #000, -2px 2px 0 #000, 2px 2px 0 #000, 0 0 4px #000, 0 0 1px #000, 0 0 12px #000;</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>.heat-waves {</p>
<p class="p1"><span class="Apple-converted-space">    </span>position: absolute;</p>
<p class="p1"><span class="Apple-converted-space">    </span>top: 32px;</p>
<p class="p1"><span class="Apple-converted-space">    </span>left: 50%;</p>
<p class="p1"><span class="Apple-converted-space">    </span>transform: translateX(-50%);</p>
<p class="p1"><span class="Apple-converted-space">    </span>font-size: 12px;</p>
<p class="p1"><span class="Apple-converted-space">    </span>animation: heatWave 2s ease-in-out infinite;</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>.heat-waves.with-wind {</p>
<p class="p1"><span class="Apple-converted-space">    </span>left: 1%;</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>@keyframes heatWave {</p>
<p class="p1"><span class="Apple-converted-space">    </span>0%, 100% { transform: translateX(-50%) translateY(0px); opacity: 0.7; }</p>
<p class="p1"><span class="Apple-converted-space">    </span>50% { transform: translateX(-50%) translateY(-2px); opacity: 1; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>.wind-waves {</p>
<p class="p1"><span class="Apple-converted-space">    </span>position: absolute;</p>
<p class="p1"><span class="Apple-converted-space">    </span>top: 30px;</p>
<p class="p1"><span class="Apple-converted-space">    </span>left: 97%;</p>
<p class="p1"><span class="Apple-converted-space">    </span>transform: translateX(-50%);</p>
<p class="p1"><span class="Apple-converted-space">    </span>font-size: 10px;</p>
<p class="p1"><span class="Apple-converted-space">    </span>animation: windWave 1.5s ease-in-out infinite;</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>.wind-waves.only-wind {</p>
<p class="p1"><span class="Apple-converted-space">    </span>left: 50%;</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>@keyframes windWave {</p>
<p class="p1"><span class="Apple-converted-space">    </span>0%, 100% { transform: translateX(-50%) translateY(0px); opacity: 0.8; }</p>
<p class="p1"><span class="Apple-converted-space">    </span>50% { transform: translateX(-50%) translateY(-2px); opacity: 1; }</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>.icon-text-shadow {</p>
<p class="p1"><span class="Apple-converted-space">    </span>color: white;</p>
<p class="p1"><span class="Apple-converted-space">    </span>font-size: 1.3em;</p>
<p class="p1"><span class="Apple-converted-space">    </span>text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000, -2px -2px 0 #000, 2px -2px 0 #000, -2px 2px 0 #000, 2px 2px 0 #000, 0 0 4px #000, 0 0 1px #000, 0 0 12px #000;</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>.location-row {</p>
<p class="p1"><span class="Apple-converted-space">    </span>margin-top: -2.4px;</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>.weather-row {</p>
<p class="p1"><span class="Apple-converted-space">    </span>margin-top: -4.25px;</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;/style&gt;&lt;/head&gt;&lt;body class="text-white"&gt;</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;div id="info" class="position-absolute top-0 start-0 d-flex flex-column gap-1 rounded" style="padding:8px;"&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="d-flex align-items-center fs-5 fw-bold text-shadow text-nowrap"&gt;&lt;i class="fa-regular fa-clock info-icon icon-text-shadow me-2"&gt;&lt;/i&gt;&lt;span id="time"&gt;--:--:--&lt;/span&gt;&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="d-flex align-items-center fs-5 fw-bold text-shadow text-nowrap location-row"&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;span class="info-icon me-2"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;img id="country-flag" class="country-flag" style="width: 20px; height: 15px; border-radius: 2px; transform: translateY(-2px); filter: drop-shadow(-1.8px -1.8px 0 #000) drop-shadow(1.8px -1.8px 0 #000) drop-shadow(-1.8px 1.8px 0 #000) drop-shadow(1.8px 1.8px 0 #000) drop-shadow(0 0 6px #000);" alt="Location" /&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;i id="location-fallback" class="fa-solid fa-location-dot info-icon icon-text-shadow" style="display: none;"&gt;&lt;/i&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;span id="place"&gt;Waiting for GPS…&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;div class="d-flex align-items-center fs-5 fw-bold text-shadow text-nowrap weather-row"&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;span class="info-icon me-2"&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;span id="weather-icon" class="weather-icon"&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;i id="weather-icon-main" class="fa-solid fa-cloud weather-icon-main"&gt;&lt;/i&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;i id="heat-waves" class="fa-solid fa-water heat-waves" style="display: none;"&gt;&lt;/i&gt;</p>
<p class="p1"><span class="Apple-converted-space">          </span>&lt;img id="wind-waves" class="wind-waves" style="display: none; width: 16px; height: 16px; filter: drop-shadow(-1px -1px 0 #000) drop-shadow(1px -1px 0 #000) drop-shadow(-1px 1px 0 #000) drop-shadow(1px 1px 0 #000) drop-shadow(0 0 4px #000);" alt="Windy" /&gt;</p>
<p class="p1"><span class="Apple-converted-space">        </span>&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">      </span>&lt;span id="weather"&gt;--°C&lt;/span&gt;</p>
<p class="p1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;/div&gt;</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;script&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>const placeEl = document.getElementById('place');</p>
<p class="p1"><span class="Apple-converted-space">  </span>const weatherEl = document.getElementById('weather');</p>
<p class="p1"><span class="Apple-converted-space">  </span>const GOOGLE_GEO_KEY = 'YOUR_KEY';</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>let lastKnownGPSLocation = null;</p>
<p class="p1"><span class="Apple-converted-space">  </span>let gpsSuccessful = false;</p>
<p class="p1"><span class="Apple-converted-space">  </span>let gpsAttempted = false;</p>
<p class="p1"><span class="Apple-converted-space">  </span>let consecutiveGPSFailures = 0;</p>
<p class="p1"><span class="Apple-converted-space">  </span>let lastWeatherData = null; // Cache last successful weather</p>
<p class="p1"><span class="Apple-converted-space">  </span>let lastWeatherTimestamp = 0; // Track when weather was last fetched</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Add location name caching</p>
<p class="p1"><span class="Apple-converted-space">  </span>let lastLocationName = null; // Cache last successful location name</p>
<p class="p1"><span class="Apple-converted-space">  </span>let lastLocationTimestamp = 0; // Track when location name was last fetched</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Connection retry variables</p>
<p class="p1"><span class="Apple-converted-space">  </span>let isOnline = navigator.onLine;</p>
<p class="p1"><span class="Apple-converted-space">  </span>let retryAttempts = 0;</p>
<p class="p1"><span class="Apple-converted-space">  </span>let maxRetryAttempts = 3;</p>
<p class="p1"><span class="Apple-converted-space">  </span>let retryTimeouts = [];</p>
<p class="p1"><span class="Apple-converted-space">  </span>let hasConnectionIssues = false;</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Detect if we're on mobile</p>
<p class="p1"><span class="Apple-converted-space">  </span>const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);</p>
<p class="p1"><span class="Apple-converted-space">  </span>const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>function tick(){</p>
<p class="p1"><span class="Apple-converted-space">    </span>const now = new Date();</p>
<p class="p1"><span class="Apple-converted-space">    </span>const dateString = now.toLocaleDateString('en-GB', { year: 'numeric', month: '2-digit', day: '2-digit' });</p>
<p class="p1"><span class="Apple-converted-space">    </span>const timeString = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>document.getElementById('time').textContent = `${dateString}, ${timeString}`;</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>tick();<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Ensure time updates every second regardless of network issues</p>
<p class="p1"><span class="Apple-converted-space">  </span>setInterval(tick, 1000);</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Enhanced fetch with retry logic</p>
<p class="p1"><span class="Apple-converted-space">  </span>async function fetchWithRetry(url, options = {}, retryCount = 0) {</p>
<p class="p1"><span class="Apple-converted-space">    </span>let timeoutId; // Move declaration to function scope</p>
<p class="p1"><span class="Apple-converted-space">    </span>try {</p>
<p class="p1"><span class="Apple-converted-space">      </span>// Create fresh AbortController for each attempt</p>
<p class="p1"><span class="Apple-converted-space">      </span>const controller = new AbortController();</p>
<p class="p1"><span class="Apple-converted-space">      </span>timeoutId = setTimeout(() =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">        </span>controller.abort();</p>
<p class="p1"><span class="Apple-converted-space">      </span>}, 5000); // Reduced to 5 seconds for better responsiveness</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>const response = await fetch(url, {</p>
<p class="p1"><span class="Apple-converted-space">        </span>...options,</p>
<p class="p1"><span class="Apple-converted-space">        </span>signal: controller.signal</p>
<p class="p1"><span class="Apple-converted-space">      </span>});</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>clearTimeout(timeoutId);</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>if (!response.ok) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>throw new Error(`HTTP ${response.status}: ${response.statusText}`);</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Reset retry attempts on success</p>
<p class="p1"><span class="Apple-converted-space">      </span>retryAttempts = 0;</p>
<p class="p1"><span class="Apple-converted-space">      </span>hasConnectionIssues = false;</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>return response;</p>
<p class="p1"><span class="Apple-converted-space">    </span>} catch (error) {</p>
<p class="p1"><span class="Apple-converted-space">      </span>clearTimeout(timeoutId); // Ensure timeout is cleared on error too</p>
<p class="p1"><span class="Apple-converted-space">      </span>console.warn(`Fetch attempt ${retryCount + 1} failed:`, error.message);</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Better error categorization</p>
<p class="p1"><span class="Apple-converted-space">      </span>const isTimeoutError = error.name === 'AbortError';</p>
<p class="p1"><span class="Apple-converted-space">      </span>const isNetworkError = error.name === 'TypeError' || error.message.includes('Failed to fetch') || error.message.includes('ERR_CONNECTION');</p>
<p class="p1"><span class="Apple-converted-space">      </span>const isOffline = !navigator.onLine;</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>if (retryCount &lt; maxRetryAttempts &amp;&amp; (isTimeoutError || isNetworkError || isOffline)) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>hasConnectionIssues = true;</p>
<p class="p1"><span class="Apple-converted-space">        </span>const delay = Math.min(1000 * Math.pow(2, retryCount), 8000); // Exponential backoff, max 8 seconds</p>
<p class="p1"><span class="Apple-converted-space">        </span>console.log(`Retrying in ${delay}ms...`);</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>return new Promise(resolve =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">          </span>const timeoutId = setTimeout(async () =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">            </span>try {</p>
<p class="p1"><span class="Apple-converted-space">              </span>const result = await fetchWithRetry(url, options, retryCount + 1);</p>
<p class="p1"><span class="Apple-converted-space">              </span>resolve(result);</p>
<p class="p1"><span class="Apple-converted-space">            </span>} catch (err) {</p>
<p class="p1"><span class="Apple-converted-space">              </span>resolve(Promise.reject(err));</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">          </span>}, delay);</p>
<p class="p1"><span class="Apple-converted-space">          </span>retryTimeouts.push(timeoutId);</p>
<p class="p1"><span class="Apple-converted-space">        </span>});</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>throw error;</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>async function reverseGeocode(lat, lon){</p>
<p class="p1"><span class="Apple-converted-space">    </span>// Detect if we're running locally (file:// protocol) and prioritize Nominatim</p>
<p class="p1"><span class="Apple-converted-space">    </span>const isLocalFile = window.location.protocol === 'file:';</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>if (isLocalFile) {</p>
<p class="p1"><span class="Apple-converted-space">      </span>console.log('Local file detected, using Nominatim as primary geocoder');</p>
<p class="p1"><span class="Apple-converted-space">        </span>return await reverseGeocodeWithNominatim(lat, lon);</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Try Google first for hosted environments</p>
<p class="p1"><span class="Apple-converted-space">    </span>try {</p>
<p class="p1"><span class="Apple-converted-space">      </span>return await reverseGeocodeWithGoogle(lat, lon);</p>
<p class="p1"><span class="Apple-converted-space">    </span>} catch (error) {</p>
<p class="p1"><span class="Apple-converted-space">      </span>console.warn('Google geocoding failed, falling back to Nominatim:', error.message);</p>
<p class="p1"><span class="Apple-converted-space">      </span>return await reverseGeocodeWithNominatim(lat, lon);</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Helper function to filter location parts based on word count rules</p>
<p class="p1"><span class="Apple-converted-space">  </span>function filterLocationByWordCount(city, state, country) {</p>
<p class="p1"><span class="Apple-converted-space">    </span>// Count words in each component (split by spaces and filter out empty strings)</p>
<p class="p1"><span class="Apple-converted-space">    </span>const cityWords = city ? city.split(/\s+/).filter(word =&gt; word.length &gt; 0).length : 0;</p>
<p class="p1"><span class="Apple-converted-space">    </span>const stateWords = state ? state.split(/\s+/).filter(word =&gt; word.length &gt; 0).length : 0;</p>
<p class="p1"><span class="Apple-converted-space">    </span>const countryWords = country ? country.split(/\s+/).filter(word =&gt; word.length &gt; 0).length : 0;</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>console.log('Word count analysis:', {</p>
<p class="p1"><span class="Apple-converted-space">      </span>city: city, cityWords: cityWords,</p>
<p class="p1"><span class="Apple-converted-space">      </span>state: state, stateWords: stateWords,<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>country: country, countryWords: countryWords</p>
<p class="p1"><span class="Apple-converted-space">    </span>});</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Apply the filtering rules:</p>
<p class="p1"><span class="Apple-converted-space">    </span>// Hide state if:</p>
<p class="p1"><span class="Apple-converted-space">    </span>// 1. City has exactly 2 words AND state has 2+ words AND country has 2+ words, OR</p>
<p class="p1"><span class="Apple-converted-space">    </span>// 2. City has 3+ words (regardless of other word counts)</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>let filteredState = state;</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>if (city &amp;&amp; state &amp;&amp; country) {</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (cityWords &gt;= 3) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>console.log('Hiding state because city has 3+ words:', cityWords);</p>
<p class="p1"><span class="Apple-converted-space">        </span>filteredState = '';</p>
<p class="p1"><span class="Apple-converted-space">      </span>} else if (cityWords === 2 &amp;&amp; stateWords &gt;= 2 &amp;&amp; countryWords &gt;= 2) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>console.log('Hiding state due to word count rule: city=2 words, state&gt;=2 words, country&gt;=2 words');</p>
<p class="p1"><span class="Apple-converted-space">        </span>filteredState = '';</p>
<p class="p1"><span class="Apple-converted-space">      </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">        </span>console.log('Keeping state - conditions not met for hiding');</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Build final parts array with filtered state</p>
<p class="p1"><span class="Apple-converted-space">    </span>const parts = [city, filteredState, country].filter(Boolean);</p>
<p class="p1"><span class="Apple-converted-space">    </span>console.log('Final location parts after word count filtering:', parts);</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>return parts.join(", ");</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>async function reverseGeocodeWithGoogle(lat, lon) {</p>
<p class="p1"><span class="Apple-converted-space">    </span>const res = await fetchWithRetry(`https://maps.googleapis.com/maps/api/geocode/json?latlng=${lat},${lon}&amp;key=${GOOGLE_GEO_KEY}&amp;language=en&amp;result_type=locality|administrative_area_level_2|administrative_area_level_1|country`);</p>
<p class="p1"><span class="Apple-converted-space">      </span>const data = await res.json();</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>if (data.status === 'OK' &amp;&amp; data.results.length &gt; 0) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>// Collect all components from all results to make a consistent decision</p>
<p class="p1"><span class="Apple-converted-space">        </span>let allCities = [];</p>
<p class="p1"><span class="Apple-converted-space">        </span>let allStates = [];</p>
<p class="p1"><span class="Apple-converted-space">        </span>let country = '';</p>
<p class="p1"><span class="Apple-converted-space">        </span>let isJapan = false;</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Process all results to gather comprehensive location data</p>
<p class="p1"><span class="Apple-converted-space">        </span>for (let resultIndex = 0; resultIndex &lt; Math.min(data.results.length, 3); resultIndex++) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>const result = data.results[resultIndex];</p>
<p class="p1"><span class="Apple-converted-space">          </span>const components = result.address_components;</p>
<p class="p2"><span class="Apple-converted-space">          </span></p>
<p class="p1"><span class="Apple-converted-space">          </span>components.forEach(component =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const types = component.types;</p>
<p class="p1"><span class="Apple-converted-space">            </span>const name = component.long_name;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Check if location is in Japan</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (types.includes('country') &amp;&amp; (component.short_name === 'JP' || name === 'Japan')) {</p>
<p class="p1"><span class="Apple-converted-space">              </span>isJapan = true;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Collect potential city names with improved priority for specific locations</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (types.includes('locality')) {</p>
<p class="p1"><span class="Apple-converted-space">              </span>// Highest priority: actual localities (specific places like Punta Cana)</p>
<p class="p1"><span class="Apple-converted-space">              </span>allCities.push({ name, priority: 1, type: 'locality', source: `result_${resultIndex}` });</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else if (types.includes('sublocality_level_1') || types.includes('sublocality')) {</p>
<p class="p1"><span class="Apple-converted-space">              </span>// Second priority: specific sub-areas within cities</p>
<p class="p1"><span class="Apple-converted-space">              </span>allCities.push({ name, priority: 2, type: 'sublocality', source: `result_${resultIndex}` });</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else if (types.includes('administrative_area_level_2') &amp;&amp; !name.includes('County') &amp;&amp; !name.includes('District') &amp;&amp; !name.includes('Region')) {</p>
<p class="p1"><span class="Apple-converted-space">              </span>// Third priority: administrative areas that are actual cities/towns (not just administrative regions)</p>
<p class="p1"><span class="Apple-converted-space">              </span>allCities.push({ name, priority: 3, type: 'admin_level_2', source: `result_${resultIndex}` });</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else if (types.includes('administrative_area_level_3')) {</p>
<p class="p1"><span class="Apple-converted-space">              </span>// Fourth priority: more specific administrative areas</p>
<p class="p1"><span class="Apple-converted-space">              </span>allCities.push({ name, priority: 4, type: 'admin_level_3', source: `result_${resultIndex}` });</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Collect state/region names</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (types.includes('administrative_area_level_1')) {</p>
<p class="p1"><span class="Apple-converted-space">              </span>allStates.push({ name, source: `result_${resultIndex}` });</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Set country (take first one found)</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (types.includes('country') &amp;&amp; !country) {</p>
<p class="p1"><span class="Apple-converted-space">              </span>country = name;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">          </span>});</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>console.log('All collected cities:', allCities);</p>
<p class="p1"><span class="Apple-converted-space">        </span>console.log('All collected states:', allStates);</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Store Japan status globally for weather icon selection</p>
<p class="p1"><span class="Apple-converted-space">        </span>window.isLocationInJapan = isJapan;</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Deduplicate cities while preserving the most specific ones</p>
<p class="p1"><span class="Apple-converted-space">        </span>const uniqueCities = [];</p>
<p class="p1"><span class="Apple-converted-space">        </span>allCities.forEach(cityObj =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">          </span>const isDuplicate = uniqueCities.some(existing =&gt;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>existing.name.toLowerCase() === cityObj.name.toLowerCase()</p>
<p class="p1"><span class="Apple-converted-space">          </span>);</p>
<p class="p1"><span class="Apple-converted-space">          </span>if (!isDuplicate) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>uniqueCities.push(cityObj);</p>
<p class="p1"><span class="Apple-converted-space">          </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>});</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Filter out overly generic or administrative names that aren't specific locations</p>
<p class="p1"><span class="Apple-converted-space">        </span>const filteredCities = uniqueCities.filter(cityObj =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">          </span>const name = cityObj.name;</p>
<p class="p1"><span class="Apple-converted-space">          </span>const isGenericAdmin = name.includes('County') || name.includes('District') ||<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                                </span>name.includes('Region') || name.includes('Prefecture') ||</p>
<p class="p1"><span class="Apple-converted-space">                                </span>name.includes('Municipality') || name.includes('Province') ||</p>
<p class="p1"><span class="Apple-converted-space">                                </span>name.includes('-dong') || name.includes('dong,') ||<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                                   </span>name.includes('(') || name.includes(')') ||</p>
<p class="p1"><span class="Apple-converted-space">                                </span>name.includes('Ward');</p>
<p class="p1"><span class="Apple-converted-space">          </span>return !isGenericAdmin;</p>
<p class="p1"><span class="Apple-converted-space">        </span>});</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Sort by priority (lower number = higher priority) to get the most specific location</p>
<p class="p1"><span class="Apple-converted-space">        </span>const citiesToConsider = filteredCities.length &gt; 0 ? filteredCities : uniqueCities;</p>
<p class="p1"><span class="Apple-converted-space">        </span>citiesToConsider.sort((a, b) =&gt; a.priority - b.priority);</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Get the best state (most common one)</p>
<p class="p1"><span class="Apple-converted-space">        </span>const stateNames = allStates.map(s =&gt; s.name);</p>
<p class="p1"><span class="Apple-converted-space">        </span>const mostCommonState = stateNames.length &gt; 0 ? stateNames[0] : '';</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Select final city and state with consistent redundancy rules</p>
<p class="p1"><span class="Apple-converted-space">        </span>let finalCity = '';</p>
<p class="p1"><span class="Apple-converted-space">        </span>let finalState = '';</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>if (citiesToConsider.length &gt; 0) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>const bestCityObj = citiesToConsider[0];</p>
<p class="p1"><span class="Apple-converted-space">          </span>finalCity = bestCityObj.name;</p>
<p class="p2"><span class="Apple-converted-space">          </span></p>
<p class="p1"><span class="Apple-converted-space">          </span>console.log('Selected most specific city:', finalCity, 'from type:', bestCityObj.type, 'priority:', bestCityObj.priority);</p>
<p class="p2"><span class="Apple-converted-space">          </span></p>
<p class="p1"><span class="Apple-converted-space">          </span>// Apply consistent state inclusion rules</p>
<p class="p1"><span class="Apple-converted-space">          </span>if (mostCommonState) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>// Always exclude state if it's exactly the same as city (case insensitive)</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (finalCity.toLowerCase() === mostCommonState.toLowerCase()) {</p>
<p class="p1"><span class="Apple-converted-space">              </span>finalState = '';</p>
<p class="p1"><span class="Apple-converted-space">              </span>console.log('Excluding state because it matches city exactly:', finalCity, '==', mostCommonState);</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>// For Israel specifically, always exclude "Central District", "Northern District", etc.<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// when we have a proper city name, as these are administrative regions</p>
<p class="p1"><span class="Apple-converted-space">            </span>else if (country === 'Israel' &amp;&amp; mostCommonState.toLowerCase().includes('district')) {</p>
<p class="p1"><span class="Apple-converted-space">              </span>finalState = '';</p>
<p class="p1"><span class="Apple-converted-space">              </span>console.log('Excluding Israeli district for consistency:', mostCommonState);</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>// For other locations, include state if it adds meaningful information</p>
<p class="p1"><span class="Apple-converted-space">            </span>else {</p>
<p class="p1"><span class="Apple-converted-space">              </span>// Check if state is a generic administrative name that doesn't add value</p>
<p class="p1"><span class="Apple-converted-space">              </span>const genericStateTerms = ['region', 'province', 'territory', 'district', 'area'];</p>
<p class="p1"><span class="Apple-converted-space">              </span>const isGenericState = genericStateTerms.some(term =&gt;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>mostCommonState.toLowerCase().includes(term)</p>
<p class="p1"><span class="Apple-converted-space">              </span>);</p>
<p class="p2"><span class="Apple-converted-space">              </span></p>
<p class="p1"><span class="Apple-converted-space">              </span>// Include state if it's not generic and provides useful geographic context</p>
<p class="p1"><span class="Apple-converted-space">              </span>if (!isGenericState) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>finalState = mostCommonState;</p>
<p class="p1"><span class="Apple-converted-space">                </span>console.log('Including state for geographic context:', mostCommonState);</p>
<p class="p1"><span class="Apple-converted-space">              </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                </span>finalState = '';</p>
<p class="p1"><span class="Apple-converted-space">                </span>console.log('Excluding generic state for specificity:', mostCommonState);</p>
<p class="p1"><span class="Apple-converted-space">              </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">          </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// If still no city, try administrative areas as backup</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (!finalCity &amp;&amp; mostCommonState) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>finalCity = mostCommonState;</p>
<p class="p1"><span class="Apple-converted-space">          </span>finalState = '';</p>
<p class="p1"><span class="Apple-converted-space">          </span>console.log('Using state as city (backup):', finalCity);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Filter out Israeli districts before assembling final location</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (country === 'Israel' &amp;&amp; finalState &amp;&amp; finalState.toLowerCase().includes('district')) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>finalState = '';</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Additional redundancy check for city-states (Singapore, Monaco, Vatican, etc.)</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (finalCity &amp;&amp; country) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>const cityLower = finalCity.toLowerCase();</p>
<p class="p1"><span class="Apple-converted-space">          </span>const countryLower = country.toLowerCase();</p>
<p class="p2"><span class="Apple-converted-space">          </span></p>
<p class="p1"><span class="Apple-converted-space">          </span>// Special handling for city-states where city equals country</p>
<p class="p1"><span class="Apple-converted-space">          </span>if (cityLower === countryLower) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>console.log('Detected city-state redundancy:', finalCity, '==', country);</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// For city-states like Singapore, check if we have a more specific area/neighborhood</p>
<p class="p1"><span class="Apple-converted-space">            </span>// Look for the most specific location that isn't the country name</p>
<p class="p1"><span class="Apple-converted-space">            </span>const specificAreas = citiesToConsider.filter(cityObj =&gt;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">              </span>cityObj.name.toLowerCase() !== countryLower &amp;&amp;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">              </span>cityObj.priority &lt;= 4 // Only consider specific areas, not generic administrative regions</p>
<p class="p1"><span class="Apple-converted-space">            </span>);</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>if (specificAreas.length &gt; 0) {</p>
<p class="p1"><span class="Apple-converted-space">              </span>// Sort by priority to get the most specific area</p>
<p class="p1"><span class="Apple-converted-space">              </span>specificAreas.sort((a, b) =&gt; a.priority - b.priority);</p>
<p class="p1"><span class="Apple-converted-space">              </span>const specificArea = specificAreas[0];</p>
<p class="p2"><span class="Apple-converted-space">              </span></p>
<p class="p1"><span class="Apple-converted-space">              </span>console.log('Found specific area within city-state:', specificArea.name, 'type:', specificArea.type);</p>
<p class="p1"><span class="Apple-converted-space">              </span>finalCity = specificArea.name;</p>
<p class="p1"><span class="Apple-converted-space">              </span>// Keep country for context (e.g., "Tampines, Singapore")</p>
<p class="p1"><span class="Apple-converted-space">              </span>finalState = ''; // Clear state to avoid triple names</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">              </span>// No specific area found, show just the city-state name</p>
<p class="p1"><span class="Apple-converted-space">              </span>country = '';</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">          </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Extract country code for flag display before filtering</p>
<p class="p1"><span class="Apple-converted-space">        </span>let countryCode = null;</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (data.results &amp;&amp; data.results.length &gt; 0) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>for (const result of data.results) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const countryComponent = result.address_components.find(comp =&gt;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">              </span>comp.types.includes('country')</p>
<p class="p1"><span class="Apple-converted-space">            </span>);</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (countryComponent) {</p>
<p class="p1"><span class="Apple-converted-space">              </span>countryCode = countryComponent.short_name;</p>
<p class="p1"><span class="Apple-converted-space">              </span>break;</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">          </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Store country info for flag display</p>
<p class="p1"><span class="Apple-converted-space">        </span>window.currentCountryName = country;</p>
<p class="p1"><span class="Apple-converted-space">        </span>window.currentCountryCode = countryCode;</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>console.log('Google geocoding - before word count filtering:', finalCity, finalState, country);</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Apply word count filtering rules</p>
<p class="p1"><span class="Apple-converted-space">        </span>return filterLocationByWordCount(finalCity, finalState, country);</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Check for API quota/permission issues</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (data.status === 'REQUEST_DENIED' || data.status === 'OVER_QUERY_LIMIT') {</p>
<p class="p1"><span class="Apple-converted-space">        </span>console.warn('Google Geocoding API access issue:', data.status, data.error_message);</p>
<p class="p1"><span class="Apple-converted-space">        </span>throw new Error(`Google API ${data.status}: ${data.error_message || 'Access denied or quota exceeded'}`);</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Safer fallback - extract only city, state, country from formatted address</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (data.results &amp;&amp; data.results.length &gt; 0) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>const formattedAddr = data.results[0].formatted_address;</p>
<p class="p1"><span class="Apple-converted-space">        </span>const addressParts = formattedAddr.split(', ');</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Try to extract only the broader location components (last 2-3 parts typically)</p>
<p class="p1"><span class="Apple-converted-space">        </span>// Skip detailed addresses like street numbers, building names, etc.</p>
<p class="p1"><span class="Apple-converted-space">        </span>const broadParts = addressParts.slice(-3).filter(part =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">          </span>// Filter out postal codes, detailed street addresses</p>
<p class="p1"><span class="Apple-converted-space">          </span>return !part.match(/^\d+/) &amp;&amp; // No leading numbers</p>
<p class="p1"><span class="Apple-converted-space">                 </span>!part.includes('#') &amp;&amp; // No building numbers</p>
<p class="p1"><span class="Apple-converted-space">                 </span>!part.includes('Suite') &amp;&amp; // No suite numbers</p>
<p class="p1"><span class="Apple-converted-space">                 </span>!part.includes('Floor') &amp;&amp; // No floor numbers</p>
<p class="p1"><span class="Apple-converted-space">                 </span>part.length &gt; 2; // Reasonable length</p>
<p class="p1"><span class="Apple-converted-space">        </span>});</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Additional redundancy check for formatted address parts</p>
<p class="p1"><span class="Apple-converted-space">        </span>const filteredParts = [];</p>
<p class="p1"><span class="Apple-converted-space">        </span>broadParts.forEach((part, index) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">          </span>const isRedundant = filteredParts.some(existingPart =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">            </span>const p1 = part.toLowerCase();</p>
<p class="p1"><span class="Apple-converted-space">            </span>const p2 = existingPart.toLowerCase();</p>
<p class="p1"><span class="Apple-converted-space">            </span>return p1.includes(p2) || p2.includes(p1) ||<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                   </span>p1.replace(/\s+(region|province|state|prefecture|district)$/, '') === p2 ||</p>
<p class="p1"><span class="Apple-converted-space">                   </span>p2.replace(/\s+(region|province|state|prefecture|district)$/, '') === p1;</p>
<p class="p1"><span class="Apple-converted-space">          </span>});</p>
<p class="p2"><span class="Apple-converted-space">          </span></p>
<p class="p1"><span class="Apple-converted-space">          </span>// Filter out Israeli districts specifically</p>
<p class="p1"><span class="Apple-converted-space">          </span>const isIsraeliDistrict = part.toLowerCase().includes('district') &amp;&amp;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                                  </span>broadParts.some(p =&gt; p.toLowerCase() === 'israel');</p>
<p class="p2"><span class="Apple-converted-space">          </span></p>
<p class="p1"><span class="Apple-converted-space">          </span>if (!isRedundant &amp;&amp; !isIsraeliDistrict) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>filteredParts.push(part);</p>
<p class="p1"><span class="Apple-converted-space">          </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>});</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Additional check for city-states in formatted address fallback</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (filteredParts.length &gt; 1) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>const lastPart = filteredParts[filteredParts.length - 1];</p>
<p class="p1"><span class="Apple-converted-space">          </span>const secondLastPart = filteredParts[filteredParts.length - 2];</p>
<p class="p2"><span class="Apple-converted-space">          </span></p>
<p class="p1"><span class="Apple-converted-space">          </span>// If last two parts are identical (city-state case), remove the duplicate</p>
<p class="p1"><span class="Apple-converted-space">          </span>if (lastPart.toLowerCase() === secondLastPart.toLowerCase()) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>console.log('Detected city-state redundancy in formatted address:', secondLastPart, '==', lastPart);</p>
<p class="p1"><span class="Apple-converted-space">            </span>filteredParts.pop(); // Remove the duplicate</p>
<p class="p1"><span class="Apple-converted-space">          </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// For fallback formatted address, apply word count filtering if we have 3 parts (city, state, country)</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (filteredParts.length === 3) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>console.log('Google fallback - applying word count filtering to formatted address parts:', filteredParts);</p>
<p class="p1"><span class="Apple-converted-space">          </span>return filterLocationByWordCount(filteredParts[0], filteredParts[1], filteredParts[2]);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>return filteredParts.join(", ");</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>throw new Error('No results from Google Geocoding');</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>async function reverseGeocodeWithNominatim(lat, lon) {</p>
<p class="p1"><span class="Apple-converted-space">    </span>const res = await fetchWithRetry(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&amp;lon=${lon}&amp;format=json&amp;accept-language=en&amp;addressdetails=1&amp;extratags=1`);</p>
<p class="p1"><span class="Apple-converted-space">      </span>const geo = await res.json();</p>
<p class="p1"><span class="Apple-converted-space">      </span>const addr = geo.address;</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>console.log('Nominatim address components:', addr);</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Check if Japan in Nominatim response</p>
<p class="p1"><span class="Apple-converted-space">      </span>window.isLocationInJapan = addr.country_code === 'jp' || addr.country === 'Japan' || addr.country === '<span class="s1">日本</span>';</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Enhanced Nominatim city name selection prioritizing specific locations</p>
<p class="p1"><span class="Apple-converted-space">      </span>let city = '';</p>
<p class="p1"><span class="Apple-converted-space">      </span>let state = '';</p>
<p class="p1"><span class="Apple-converted-space">      </span>let country = addr.country || '';</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Collect all potential city names from Nominatim with updated priorities for specificity</p>
<p class="p1"><span class="Apple-converted-space">      </span>let potentialCities = [];</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Priority 1: Most specific location designations (actual places)</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (addr.city &amp;&amp; !addr.city.includes('Capital') &amp;&amp; !addr.city.includes('City of')) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>potentialCities.push({ name: addr.city, priority: 1, type: 'city' });</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (addr.town &amp;&amp; !addr.town.includes('Capital') &amp;&amp; !addr.town.includes('City of')) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>potentialCities.push({ name: addr.town, priority: 1, type: 'town' });</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (addr.village &amp;&amp; !addr.village.includes('Capital') &amp;&amp; !addr.village.includes('City of')) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>potentialCities.push({ name: addr.village, priority: 1, type: 'village' });</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Priority 2: Specific settlements and localities (like resort areas, specific neighborhoods)</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (addr.hamlet) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>potentialCities.push({ name: addr.hamlet, priority: 2, type: 'hamlet' });</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (addr.locality &amp;&amp; addr.locality !== addr.city &amp;&amp; addr.locality !== addr.town) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>potentialCities.push({ name: addr.locality, priority: 2, type: 'locality' });</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (addr.quarter &amp;&amp; addr.quarter !== addr.city &amp;&amp; addr.quarter !== addr.town) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>potentialCities.push({ name: addr.quarter, priority: 2, type: 'quarter' });</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (addr.residential &amp;&amp; addr.residential !== addr.city &amp;&amp; addr.residential !== addr.town) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>potentialCities.push({ name: addr.residential, priority: 2, type: 'residential' });</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Priority 3: Municipality names (often the actual city name)</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (addr.municipality &amp;&amp; addr.municipality !== addr.city &amp;&amp; addr.municipality !== addr.town) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>potentialCities.push({ name: addr.municipality, priority: 3, type: 'municipality' });</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Priority 4: Suburban/district areas (more specific than administrative regions)</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (addr.suburb &amp;&amp; addr.suburb !== addr.city &amp;&amp; addr.suburb !== addr.town) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>potentialCities.push({ name: addr.suburb, priority: 4, type: 'suburb' });</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (addr.neighbourhood &amp;&amp; addr.neighbourhood !== addr.city &amp;&amp; addr.neighbourhood !== addr.town) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>potentialCities.push({ name: addr.neighbourhood, priority: 4, type: 'neighbourhood' });</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Priority 5: County as city name (only if it's not just "County")</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (addr.county &amp;&amp; addr.county !== addr.city &amp;&amp; addr.county !== addr.town &amp;&amp; !addr.county.includes('County')) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>potentialCities.push({ name: addr.county, priority: 5, type: 'county' });</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Priority 6: State/region as last resort (least specific)</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (addr.state &amp;&amp; addr.state !== addr.city &amp;&amp; addr.state !== addr.town) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>potentialCities.push({ name: addr.state, priority: 6, type: 'state_as_city' });</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>console.log('Nominatim potential cities:', potentialCities);</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Filter out overly detailed districts and administrative names</p>
<p class="p1"><span class="Apple-converted-space">      </span>const filteredCities = potentialCities.filter(cityObj =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">        </span>const name = cityObj.name;</p>
<p class="p1"><span class="Apple-converted-space">        </span>const isDetailedDistrict = name.includes('-dong') || name.includes('dong,') ||<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                                 </span>name.includes('(') || name.includes(')') ||</p>
<p class="p1"><span class="Apple-converted-space">                                 </span>name.includes('Ward') || name.includes('District') ||</p>
<p class="p1"><span class="Apple-converted-space">                                 </span>name.includes('Capital') || name.includes('City of') ||</p>
<p class="p1"><span class="Apple-converted-space">                                 </span>name.includes('County') || name.includes('Region');</p>
<p class="p1"><span class="Apple-converted-space">        </span>return !isDetailedDistrict;</p>
<p class="p1"><span class="Apple-converted-space">      </span>});</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Choose the most specific city name (lowest priority number = most specific)</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (filteredCities.length &gt; 0) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>// Sort by priority (lower number = higher priority = more specific)</p>
<p class="p1"><span class="Apple-converted-space">        </span>filteredCities.sort((a, b) =&gt; a.priority - b.priority);</p>
<p class="p1"><span class="Apple-converted-space">        </span>const bestCity = filteredCities[0];</p>
<p class="p1"><span class="Apple-converted-space">        </span>city = bestCity.name;</p>
<p class="p1"><span class="Apple-converted-space">        </span>console.log('Selected most specific Nominatim city:', city, 'from type:', bestCity.type, 'priority:', bestCity.priority);</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Don't use state as city if we found a real city</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (bestCity.type === 'state_as_city') {</p>
<p class="p1"><span class="Apple-converted-space">          </span>state = ''; // Don't duplicate state</p>
<p class="p1"><span class="Apple-converted-space">        </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">          </span>// Set state normally if we found a real city</p>
<p class="p1"><span class="Apple-converted-space">          </span>if (addr.state &amp;&amp; addr.state !== city &amp;&amp; !addr.state.includes('Capital') &amp;&amp; !addr.state.includes('City of')) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>state = addr.state;</p>
<p class="p1"><span class="Apple-converted-space">          </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>} else if (potentialCities.length &gt; 0) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>// Use unfiltered if filtered list is empty</p>
<p class="p1"><span class="Apple-converted-space">        </span>potentialCities.sort((a, b) =&gt; a.priority - b.priority);</p>
<p class="p1"><span class="Apple-converted-space">        </span>const bestCity = potentialCities[0];</p>
<p class="p1"><span class="Apple-converted-space">        </span>city = bestCity.name.replace(/^Capital City of /, '');</p>
<p class="p1"><span class="Apple-converted-space">        </span>console.log('Selected Nominatim city (unfiltered):', city, 'from type:', bestCity.type);</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>if (bestCity.type === 'state_as_city') {</p>
<p class="p1"><span class="Apple-converted-space">          </span>state = '';</p>
<p class="p1"><span class="Apple-converted-space">        </span>} else if (addr.state &amp;&amp; addr.state !== city) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>state = addr.state;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Enhanced redundancy removal for Nominatim</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (city &amp;&amp; state) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>const cityLower = city.toLowerCase();</p>
<p class="p1"><span class="Apple-converted-space">        </span>const stateLower = state.toLowerCase();</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>const isRedundant = cityLower === stateLower ||</p>
<p class="p1"><span class="Apple-converted-space">                           </span>cityLower.includes(stateLower) ||<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">                           </span>stateLower.includes(cityLower) ||</p>
<p class="p1"><span class="Apple-converted-space">                           </span>cityLower === stateLower.replace(/\s+(region|province|state|prefecture|district|county)$/, '') ||</p>
<p class="p1"><span class="Apple-converted-space">                           </span>stateLower === cityLower.replace(/\s+(region|province|state|prefecture|district|county)$/, '');</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>if (isRedundant) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>console.log('Detected Nominatim redundancy between city and state:', city, '/', state);</p>
<p class="p1"><span class="Apple-converted-space">          </span>// Prefer the shorter, more specific name</p>
<p class="p1"><span class="Apple-converted-space">          </span>if (city.length &lt;= state.length) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>state = ''; // Keep city, remove state</p>
<p class="p1"><span class="Apple-converted-space">          </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">            </span>city = state; // Use state as city</p>
<p class="p1"><span class="Apple-converted-space">            </span>state = '';</p>
<p class="p1"><span class="Apple-converted-space">          </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Additional redundancy check for city-states (Singapore, Monaco, Vatican, etc.)</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (city &amp;&amp; country) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>const cityLower = city.toLowerCase();</p>
<p class="p1"><span class="Apple-converted-space">        </span>const countryLower = country.toLowerCase();</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Special handling for city-states where city equals country</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (cityLower === countryLower) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>console.log('Detected city-state redundancy:', city, '==', country);</p>
<p class="p2"><span class="Apple-converted-space">          </span></p>
<p class="p1"><span class="Apple-converted-space">          </span>// For city-states like Singapore, check if we have a more specific area/neighborhood</p>
<p class="p1"><span class="Apple-converted-space">          </span>// Look for the most specific location that isn't the country name</p>
<p class="p1"><span class="Apple-converted-space">          </span>const specificAreas = potentialCities.filter(cityObj =&gt;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>cityObj.name.toLowerCase() !== countryLower &amp;&amp;<span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>cityObj.priority &lt;= 4 // Only consider specific areas, not generic administrative regions</p>
<p class="p1"><span class="Apple-converted-space">          </span>);</p>
<p class="p2"><span class="Apple-converted-space">          </span></p>
<p class="p1"><span class="Apple-converted-space">          </span>if (specificAreas.length &gt; 0) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>// Sort by priority to get the most specific area</p>
<p class="p1"><span class="Apple-converted-space">            </span>specificAreas.sort((a, b) =&gt; a.priority - b.priority);</p>
<p class="p1"><span class="Apple-converted-space">            </span>const specificArea = specificAreas[0];</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>console.log('Found specific area within city-state:', specificArea.name, 'type:', specificArea.type);</p>
<p class="p1"><span class="Apple-converted-space">            </span>city = specificArea.name;</p>
<p class="p1"><span class="Apple-converted-space">            </span>// Keep country for context (e.g., "Tampines, Singapore")</p>
<p class="p1"><span class="Apple-converted-space">            </span>state = ''; // Clear state to avoid triple names</p>
<p class="p1"><span class="Apple-converted-space">          </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">            </span>// No specific area found, show just the city-state name</p>
<p class="p1"><span class="Apple-converted-space">            </span>country = '';</p>
<p class="p1"><span class="Apple-converted-space">          </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Filter out Israeli districts before assembling final location</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (country === 'Israel' &amp;&amp; state &amp;&amp; state.toLowerCase().includes('district')) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>state = '';</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Store country info for flag display before filtering</p>
<p class="p1"><span class="Apple-converted-space">      </span>window.currentCountryName = country;</p>
<p class="p1"><span class="Apple-converted-space">      </span>window.currentCountryCode = addr.country_code ? addr.country_code.toUpperCase() : null;</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>console.log('Nominatim geocoding - before word count filtering:', city, state, country);</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Apply word count filtering rules</p>
<p class="p1"><span class="Apple-converted-space">      </span>return filterLocationByWordCount(city, state, country);</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Google Weather condition mapping for Open-Meteo weather codes</p>
<p class="p1"><span class="Apple-converted-space">  </span>const googleWeatherCodes = {</p>
<p class="p1"><span class="Apple-converted-space">    </span>0: { condition: 'CLEAR', description: 'Clear' },</p>
<p class="p1"><span class="Apple-converted-space">    </span>1: { condition: 'MOSTLY_CLEAR', description: 'Few Clouds' },</p>
<p class="p1"><span class="Apple-converted-space">    </span>2: { condition: 'PARTLY_CLOUDY', description: 'Few Clouds' },</p>
<p class="p1"><span class="Apple-converted-space">    </span>3: { condition: 'MOSTLY_CLOUDY', description: 'Cloudy' },</p>
<p class="p1"><span class="Apple-converted-space">    </span>45: { condition: 'FOG', description: 'Fog' },</p>
<p class="p1"><span class="Apple-converted-space">    </span>48: { condition: 'FOG', description: 'Depositing Rime Fog' },</p>
<p class="p1"><span class="Apple-converted-space">    </span>51: { condition: 'LIGHT_RAIN_SHOWERS', description: 'Light Drizzle' },</p>
<p class="p1"><span class="Apple-converted-space">    </span>53: { condition: 'LIGHT_RAIN_SHOWERS', description: 'Moderate Drizzle' },</p>
<p class="p1"><span class="Apple-converted-space">    </span>55: { condition: 'LIGHT_RAIN_SHOWERS', description: 'Dense Drizzle' },</p>
<p class="p1"><span class="Apple-converted-space">    </span>56: { condition: 'LIGHT_RAIN_SHOWERS', description: 'Light Freezing Drizzle' },</p>
<p class="p1"><span class="Apple-converted-space">    </span>57: { condition: 'LIGHT_RAIN_SHOWERS', description: 'Dense Freezing Drizzle' },</p>
<p class="p1"><span class="Apple-converted-space">    </span>61: { condition: 'LIGHT_RAIN_SHOWERS', description: 'Light Rain' },</p>
<p class="p1"><span class="Apple-converted-space">    </span>63: { condition: 'RAIN_SHOWERS', description: 'Moderate Rain' },</p>
<p class="p1"><span class="Apple-converted-space">    </span>65: { condition: 'HEAVY_RAIN_SHOWERS', description: 'Heavy Rain' },</p>
<p class="p1"><span class="Apple-converted-space">    </span>66: { condition: 'LIGHT_RAIN_SHOWERS', description: 'Light Freezing Rain' },</p>
<p class="p1"><span class="Apple-converted-space">    </span>67: { condition: 'HEAVY_RAIN_SHOWERS', description: 'Heavy Freezing Rain' },</p>
<p class="p1"><span class="Apple-converted-space">    </span>71: { condition: 'LIGHT_SNOW', description: 'Light Snow' },</p>
<p class="p1"><span class="Apple-converted-space">    </span>73: { condition: 'SNOW', description: 'Moderate Snow' },</p>
<p class="p1"><span class="Apple-converted-space">    </span>75: { condition: 'HEAVY_SNOW', description: 'Heavy Snow' },</p>
<p class="p1"><span class="Apple-converted-space">    </span>77: { condition: 'LIGHT_SNOW', description: 'Snow Grains' },</p>
<p class="p1"><span class="Apple-converted-space">    </span>80: { condition: 'LIGHT_RAIN_SHOWERS', description: 'Light Rain' },</p>
<p class="p1"><span class="Apple-converted-space">    </span>81: { condition: 'RAIN_SHOWERS', description: 'Moderate Rain' },</p>
<p class="p1"><span class="Apple-converted-space">    </span>82: { condition: 'HEAVY_RAIN_SHOWERS', description: 'Heavy Rain' },</p>
<p class="p1"><span class="Apple-converted-space">    </span>85: { condition: 'LIGHT_SNOW_SHOWERS', description: 'Light Snow' },</p>
<p class="p1"><span class="Apple-converted-space">    </span>86: { condition: 'HEAVY_SNOW_SHOWERS', description: 'Snow Showers' },</p>
<p class="p1"><span class="Apple-converted-space">    </span>95: { condition: 'THUNDERSTORM', description: 'Thunderstorm' },</p>
<p class="p1"><span class="Apple-converted-space">    </span>96: { condition: 'THUNDERSTORM', description: 'Thunderstorm with Light Hail' },</p>
<p class="p1"><span class="Apple-converted-space">    </span>99: { condition: 'THUNDERSTORM', description: 'Thunderstorm with Heavy Hail' }</p>
<p class="p1"><span class="Apple-converted-space">  </span>};</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Function to get Google weather icon URL based on weather code and time</p>
<p class="p1"><span class="Apple-converted-space">  </span>function getGoogleWeatherIcon(weatherCode, isDay = true, condition = null) {</p>
<p class="p1"><span class="Apple-converted-space">    </span>// Use passed condition or derive from weather code</p>
<p class="p1"><span class="Apple-converted-space">    </span>const finalCondition = condition || googleWeatherCodes[weatherCode]?.condition || 'CLOUDY';</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Repository base URL for v4 icons (now primary for everyone)</p>
<p class="p1"><span class="Apple-converted-space">    </span>const repoBaseUrl = '';</p>
<p class="p1"><span class="Apple-converted-space">    </span>const fallbackUrl = 'https://maps.gstatic.com/weather/v1/';</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Standard Google Maps weather icon mapping for fallback</p>
<p class="p1"><span class="Apple-converted-space">    </span>const standardIconMap = {</p>
<p class="p1"><span class="Apple-converted-space">      </span>'CLEAR': isDay ? 'sunny.svg' : 'clear.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'MOSTLY_CLEAR': isDay ? 'mostly_sunny.svg' : 'mostly_clear.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'PARTLY_CLOUDY': isDay ? 'party_cloudy.svg' : 'partly_clear.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'MOSTLY_CLOUDY': isDay ? 'cloudy.svg' : 'cloudy.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'CLOUDY': 'cloudy.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'FOG': 'fog.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'LIGHT_RAIN_SHOWERS': 'drizzle.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'RAIN_SHOWERS': 'showers.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'HEAVY_RAIN_SHOWERS': 'heavy.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'LIGHT_RAIN': 'drizzle.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'RAIN': 'rain.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'HEAVY_RAIN': 'heavy.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'LIGHT_SNOW_SHOWERS': 'flurries.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'SNOW_SHOWERS': 'snow_showers.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'HEAVY_SNOW_SHOWERS': 'heavy_snow.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'LIGHT_SNOW': 'flurries.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'SNOW': 'snow_showers.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'HEAVY_SNOW': 'heavy_snow.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'SNOWSTORM': 'snow_showers.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'SNOW_PERIODICALLY_HEAVY': 'heavy_snow.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'HEAVY_SNOW_STORM': 'heavy_snow.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'BLOWING_SNOW': 'blowing_snow.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'RAIN_AND_SNOW': 'wintry_mix.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'HAIL': 'sleet_hail.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'HAIL_SHOWERS': 'wintry_mix.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'THUNDERSTORM': 'strong_tstorms.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'THUNDERSHOWER': 'strong_tstorms.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'LIGHT_THUNDERSTORM_RAIN': 'strong_tstorms.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'SCATTERED_THUNDERSTORMS': 'isolated_tstorms.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'HEAVY_THUNDERSTORM': 'strong_tstorms.svg'</p>
<p class="p1"><span class="Apple-converted-space">    </span>};</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>// v4 repository weather icon mapping (now primary for everyone)</p>
<p class="p1"><span class="Apple-converted-space">    </span>const v4IconMap = {</p>
<p class="p1"><span class="Apple-converted-space">      </span>'CLEAR': isDay ? 'clear_day.svg' : 'clear_night.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'MOSTLY_CLEAR': isDay ? 'mostly_clear_day.svg' : 'mostly_clear_night.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'PARTLY_CLOUDY': isDay ? 'partly_cloudy_day.svg' : 'partly_cloudy_night.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'MOSTLY_CLOUDY': isDay ? 'mostly_cloudy_day.svg' : 'mostly_cloudy_night.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'CLOUDY': 'cloudy.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'FOG': 'haze_fog_dust_smoke.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'LIGHT_RAIN_SHOWERS': 'drizzle.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'RAIN_SHOWERS': isDay ? 'scattered_showers_day.svg' : 'scattered_showers_night.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'HEAVY_RAIN_SHOWERS': 'showers_rain.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'LIGHT_RAIN': isDay ? 'rain_with_cloudy_light.svg' : 'rain_with_cloudy_dark.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'RAIN': isDay ? 'rain_with_cloudy_light.svg' : 'rain_with_cloudy_dark.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'HEAVY_RAIN': 'heavy_rain.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'LIGHT_SNOW_SHOWERS': isDay ? 'scattered_snow_showers_day.svg' : 'scattered_snow_showers_night.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'SNOW_SHOWERS': 'showers_snow.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'HEAVY_SNOW_SHOWERS': 'showers_snow.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'LIGHT_SNOW': isDay ? 'snow_with_cloudy_light.svg' : 'snow_with_cloudy_dark.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'SNOW': isDay ? 'snow_with_cloudy_light.svg' : 'snow_with_cloudy_dark.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'HEAVY_SNOW': 'heavy_snow.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'SNOWSTORM': 'heavy_snow.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'SNOW_PERIODICALLY_HEAVY': 'heavy_snow.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'HEAVY_SNOW_STORM': 'heavy_snow.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'BLOWING_SNOW': 'blowing_snow.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'RAIN_AND_SNOW': 'mixed_rain_snow.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'HAIL': 'sleet_hail.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'HAIL_SHOWERS': 'mixed_rain_hail_sleet.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'THUNDERSTORM': isDay ? 'isolated_scattered_thunderstorms_day.svg' : 'isolated_scattered_thunderstorms_night.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'THUNDERSHOWER': isDay ? 'isolated_scattered_thunderstorms_day.svg' : 'isolated_scattered_thunderstorms_night.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'LIGHT_THUNDERSTORM_RAIN': isDay ? 'isolated_scattered_thunderstorms_day.svg' : 'isolated_scattered_thunderstorms_night.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'SCATTERED_THUNDERSTORMS': isDay ? 'isolated_scattered_thunderstorms_day.svg' : 'isolated_scattered_thunderstorms_night.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'HEAVY_THUNDERSTORM': 'isolated_thunderstorms.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'ICY': 'icy.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'BLIZZARD': 'blizzard.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'TORNADO': 'tornado.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'TROPICAL_STORM': 'tropical_storm_hurricane.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'VERY_HOT': 'very_hot.svg',</p>
<p class="p1"><span class="Apple-converted-space">      </span>'VERY_COLD': 'very_cold.svg'</p>
<p class="p1"><span class="Apple-converted-space">    </span>};</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Use v4 repository icons as primary for everyone, with Google Maps as fallback</p>
<p class="p1"><span class="Apple-converted-space">    </span>const v4Icon = v4IconMap[finalCondition] || 'cloudy.svg';</p>
<p class="p1"><span class="Apple-converted-space">    </span>const fallbackIcon = standardIconMap[finalCondition] || 'cloudy.svg';</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>console.log('<span class="s2">🎌</span> Using v4 repository weather icon (primary):', v4Icon, 'for condition:', finalCondition);</p>
<p class="p1"><span class="Apple-converted-space">    </span>return {</p>
<p class="p1"><span class="Apple-converted-space">      </span>primary: repoBaseUrl + v4Icon,</p>
<p class="p1"><span class="Apple-converted-space">      </span>fallback: fallbackUrl + fallbackIcon</p>
<p class="p1"><span class="Apple-converted-space">    </span>};</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Enhanced heat wave detection based on regional climate context</p>
<p class="p1"><span class="Apple-converted-space">  </span>function determineHeatWaveThreshold(lat) {</p>
<p class="p1"><span class="Apple-converted-space">    </span>// Regional temperature thresholds based on latitude and typical climate zones</p>
<p class="p1"><span class="Apple-converted-space">    </span>const tempThresholds = {</p>
<p class="p1"><span class="Apple-converted-space">      </span>// Arctic/Subarctic (above 60°N)</p>
<p class="p1"><span class="Apple-converted-space">      </span>arctic: { threshold: 20, region: 'Arctic' },</p>
<p class="p1"><span class="Apple-converted-space">      </span>// Northern temperate (45-60°N) <span class="Apple-converted-space"> </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>northTemperate: { threshold: 28, region: 'Northern Temperate' },</p>
<p class="p1"><span class="Apple-converted-space">      </span>// Mid temperate (30-45°N)</p>
<p class="p1"><span class="Apple-converted-space">      </span>midTemperate: { threshold: 32, region: 'Mid Temperate' },</p>
<p class="p1"><span class="Apple-converted-space">      </span>// Subtropical (15-30°N)</p>
<p class="p1"><span class="Apple-converted-space">      </span>subtropical: { threshold: 35, region: 'Subtropical' },</p>
<p class="p1"><span class="Apple-converted-space">      </span>// Tropical (0-15°N)</p>
<p class="p1"><span class="Apple-converted-space">      </span>tropical: { threshold: 38, region: 'Tropical' },</p>
<p class="p1"><span class="Apple-converted-space">      </span>// Southern hemisphere equivalents</p>
<p class="p1"><span class="Apple-converted-space">      </span>southTropical: { threshold: 38, region: 'South Tropical' },</p>
<p class="p1"><span class="Apple-converted-space">      </span>southSubtropical: { threshold: 35, region: 'South Subtropical' },</p>
<p class="p1"><span class="Apple-converted-space">      </span>southTemperate: { threshold: 32, region: 'South Temperate' }</p>
<p class="p1"><span class="Apple-converted-space">    </span>};</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>const absLat = Math.abs(lat);</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>if (absLat &gt;= 60) return tempThresholds.arctic;</p>
<p class="p1"><span class="Apple-converted-space">    </span>if (absLat &gt;= 45) return lat &gt; 0 ? tempThresholds.northTemperate : tempThresholds.southTemperate;</p>
<p class="p1"><span class="Apple-converted-space">    </span>if (absLat &gt;= 30) return tempThresholds.midTemperate;</p>
<p class="p1"><span class="Apple-converted-space">    </span>if (absLat &gt;= 15) return lat &gt; 0 ? tempThresholds.subtropical : tempThresholds.southSubtropical;</p>
<p class="p1"><span class="Apple-converted-space">    </span>return lat &gt; 0 ? tempThresholds.tropical : tempThresholds.southTropical;</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Country flag system - maps country names and codes to flag filenames</p>
<p class="p1"><span class="Apple-converted-space">  </span>const countryFlagMap = {</p>
<p class="p1"><span class="Apple-converted-space">    </span>// Country codes (ISO 3166-1 alpha-2) - preferred format</p>
<p class="p1"><span class="Apple-converted-space">    </span>'US': 'us.svg', 'CA': 'ca.svg', 'GB': 'gb.svg', 'DE': 'de.svg', 'FR': 'fr.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'IT': 'it.svg', 'ES': 'es.svg', 'PT': 'pt.svg', 'NL': 'nl.svg', 'BE': 'be.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'CH': 'ch.svg', 'AT': 'at.svg', 'SE': 'se.svg', 'NO': 'no.svg', 'DK': 'dk.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'FI': 'fi.svg', 'IS': 'is.svg', 'IE': 'ie.svg', 'LU': 'lu.svg', 'MC': 'mc.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'AD': 'ad.svg', 'SM': 'sm.svg', 'VA': 'va.svg', 'MT': 'mt.svg', 'CY': 'cy.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'GR': 'gr.svg', 'BG': 'bg.svg', 'RO': 'ro.svg', 'HU': 'hu.svg', 'CZ': 'cz.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'SK': 'sk.svg', 'PL': 'pl.svg', 'LT': 'lt.svg', 'LV': 'lv.svg', 'EE': 'ee.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'RU': 'ru.svg', 'BY': 'by.svg', 'UA': 'ua.svg', 'MD': 'md.svg', 'RS': 'rs.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'ME': 'me.svg', 'BA': 'ba.svg', 'HR': 'hr.svg', 'SI': 'si.svg', 'MK': 'mk.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'AL': 'al.svg', 'XK': 'xk.svg', 'JP': 'jp.svg', 'KR': 'kr.svg', 'CN': 'cn.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'TW': 'tw.svg', 'HK': 'hk.svg', 'MO': 'mo.svg', 'SG': 'sg.svg', 'MY': 'my.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'TH': 'th.svg', 'VN': 'vn.svg', 'PH': 'ph.svg', 'ID': 'id.svg', 'BN': 'bn.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'IN': 'in.svg', 'PK': 'pk.svg', 'BD': 'bd.svg', 'LK': 'lk.svg', 'MV': 'mv.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'NP': 'np.svg', 'BT': 'bt.svg', 'MM': 'mm.svg', 'KH': 'kh.svg', 'LA': 'la.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'MN': 'mn.svg', 'KZ': 'kz.svg', 'KG': 'kg.svg', 'TJ': 'tj.svg', 'UZ': 'uz.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'TM': 'tm.svg', 'AF': 'af.svg', 'IR': 'ir.svg', 'IQ': 'iq.svg', 'SY': 'sy.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'LB': 'lb.svg', 'JO': 'jo.svg', 'PS': 'ps.svg', 'IL': 'il.svg', 'TR': 'tr.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'AM': 'am.svg', 'AZ': 'az.svg', 'GE': 'ge.svg', 'SA': 'sa.svg', 'AE': 'ae.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'QA': 'qa.svg', 'KW': 'kw.svg', 'BH': 'bh.svg', 'OM': 'om.svg', 'YE': 'ye.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'EG': 'eg.svg', 'LY': 'ly.svg', 'TN': 'tn.svg', 'DZ': 'dz.svg', 'MA': 'ma.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'SD': 'sd.svg', 'SS': 'ss.svg', 'ET': 'et.svg', 'ER': 'er.svg', 'DJ': 'dj.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'SO': 'so.svg', 'KE': 'ke.svg', 'UG': 'ug.svg', 'TZ': 'tz.svg', 'RW': 'rw.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'BI': 'bi.svg', 'MG': 'mg.svg', 'MU': 'mu.svg', 'SC': 'sc.svg', 'KM': 'km.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'ZA': 'za.svg', 'ZW': 'zw.svg', 'BW': 'bw.svg', 'NA': 'na.svg', 'SZ': 'sz.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'LS': 'ls.svg', 'MZ': 'mz.svg', 'MW': 'mw.svg', 'ZM': 'zm.svg', 'AO': 'ao.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'CD': 'cd.svg', 'CG': 'cg.svg', 'CF': 'cf.svg', 'TD': 'td.svg', 'CM': 'cm.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'GQ': 'gq.svg', 'GA': 'ga.svg', 'ST': 'st.svg', 'NG': 'ng.svg', 'BJ': 'bj.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'TG': 'tg.svg', 'GH': 'gh.svg', 'CI': 'ci.svg', 'LR': 'lr.svg', 'SL': 'sl.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'GN': 'gn.svg', 'GW': 'gw.svg', 'SN': 'sn.svg', 'GM': 'gm.svg', 'ML': 'ml.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'BF': 'bf.svg', 'NE': 'ne.svg', 'MR': 'mr.svg', 'AU': 'au.svg', 'NZ': 'nz.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'PG': 'pg.svg', 'FJ': 'fj.svg', 'SB': 'sb.svg', 'VU': 'vu.svg', 'NC': 'nc.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'PF': 'pf.svg', 'WS': 'ws.svg', 'TO': 'to.svg', 'TV': 'tv.svg', 'KI': 'ki.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'NR': 'nr.svg', 'PW': 'pw.svg', 'FM': 'fm.svg', 'MH': 'mh.svg', 'MX': 'mx.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'GT': 'gt.svg', 'BZ': 'bz.svg', 'SV': 'sv.svg', 'HN': 'hn.svg', 'NI': 'ni.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'CR': 'cr.svg', 'PA': 'pa.svg', 'CU': 'cu.svg', 'JM': 'jm.svg', 'HT': 'ht.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'DO': 'do.svg', 'PR': 'pr.svg', 'TT': 'tt.svg', 'BB': 'bb.svg', 'LC': 'lc.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'VC': 'vc.svg', 'GD': 'gd.svg', 'AG': 'ag.svg', 'DM': 'dm.svg', 'KN': 'kn.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'BS': 'bs.svg', 'VE': 've.svg', 'GY': 'gy.svg', 'SR': 'sr.svg', 'BR': 'br.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'CO': 'co.svg', 'EC': 'ec.svg', 'PE': 'pe.svg', 'BO': 'bo.svg', 'PY': 'py.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'AR': 'ar.svg', 'UY': 'uy.svg', 'CL': 'cl.svg', 'FK': 'fk.svg', 'GS': 'gs.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>// Country names (fallback)</p>
<p class="p1"><span class="Apple-converted-space">    </span>'United States': 'us.svg', 'Canada': 'ca.svg', 'United Kingdom': 'gb.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'Germany': 'de.svg', 'France': 'fr.svg', 'Italy': 'it.svg', 'Spain': 'es.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'Portugal': 'pt.svg', 'Netherlands': 'nl.svg', 'Belgium': 'be.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'Switzerland': 'ch.svg', 'Austria': 'at.svg', 'Sweden': 'se.svg', 'Norway': 'no.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'Denmark': 'dk.svg', 'Finland': 'fi.svg', 'Iceland': 'is.svg', 'Ireland': 'ie.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'Japan': 'jp.svg', 'South Korea': 'kr.svg', 'China': 'cn.svg', 'Taiwan': 'tw.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'Hong Kong': 'hk.svg', 'Singapore': 'sg.svg', 'Malaysia': 'my.svg', 'Thailand': 'th.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'Vietnam': 'vn.svg', 'Philippines': 'ph.svg', 'Indonesia': 'id.svg', 'India': 'in.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'Pakistan': 'pk.svg', 'Bangladesh': 'bd.svg', 'Sri Lanka': 'lk.svg', 'Nepal': 'np.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'Australia': 'au.svg', 'New Zealand': 'nz.svg', 'Mexico': 'mx.svg', 'Brazil': 'br.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'Argentina': 'ar.svg', 'Chile': 'cl.svg', 'Colombia': 'co.svg', 'Peru': 'pe.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'Venezuela': 've.svg', 'Ecuador': 'ec.svg', 'Uruguay': 'uy.svg', 'Paraguay': 'py.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'Bolivia': 'bo.svg', 'Israel': 'il.svg', 'Turkey': 'tr.svg', 'Russia': 'ru.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'Ukraine': 'ua.svg', 'Poland': 'pl.svg', 'Czech Republic': 'cz.svg', 'Hungary': 'hu.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'Romania': 'ro.svg', 'Bulgaria': 'bg.svg', 'Greece': 'gr.svg', 'Croatia': 'hr.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'Serbia': 'rs.svg', 'Bosnia and Herzegovina': 'ba.svg', 'Montenegro': 'me.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'Slovenia': 'si.svg', 'Slovakia': 'sk.svg', 'Estonia': 'ee.svg', 'Latvia': 'lv.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'Lithuania': 'lt.svg', 'Belarus': 'by.svg', 'Moldova': 'md.svg', 'Albania': 'al.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'North Macedonia': 'mk.svg', 'Kosovo': 'xk.svg', 'Cyprus': 'cy.svg', 'Malta': 'mt.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'Luxembourg': 'lu.svg', 'Monaco': 'mc.svg', 'San Marino': 'sm.svg', 'Vatican City': 'va.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'Andorra': 'ad.svg', 'South Africa': 'za.svg', 'Egypt': 'eg.svg', 'Morocco': 'ma.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'Nigeria': 'ng.svg', 'Kenya': 'ke.svg', 'Ghana': 'gh.svg', 'Ethiopia': 'et.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'Tanzania': 'tz.svg', 'Uganda': 'ug.svg', 'Madagascar': 'mg.svg', 'Cameroon': 'cm.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'Saudi Arabia': 'sa.svg', 'United Arab Emirates': 'ae.svg', 'Qatar': 'qa.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'Kuwait': 'kw.svg', 'Bahrain': 'bh.svg', 'Oman': 'om.svg', 'Yemen': 'ye.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'Jordan': 'jo.svg', 'Lebanon': 'lb.svg', 'Syria': 'sy.svg', 'Iraq': 'iq.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'Iran': 'ir.svg', 'Afghanistan': 'af.svg', 'Kazakhstan': 'kz.svg', 'Uzbekistan': 'uz.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'Turkmenistan': 'tm.svg', 'Kyrgyzstan': 'kg.svg', 'Tajikistan': 'tj.svg',</p>
<p class="p1"><span class="Apple-converted-space">    </span>'Mongolia': 'mn.svg', 'Myanmar': 'mm.svg', 'Cambodia': 'kh.svg', 'Laos': 'la.svg'</p>
<p class="p1"><span class="Apple-converted-space">  </span>};</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Function to get country flag icon URLs</p>
<p class="p1"><span class="Apple-converted-space">  </span>function getCountryFlagIcon(countryName, countryCode) {</p>
<p class="p1"><span class="Apple-converted-space">    </span>// Repository base URL for 4x3 flag icons</p>
<p class="p1"><span class="Apple-converted-space">    </span>const repoBaseUrl = '';</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Try country code first (more reliable)</p>
<p class="p1"><span class="Apple-converted-space">    </span>let flagFile = null;</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>if (countryCode) {</p>
<p class="p1"><span class="Apple-converted-space">      </span>const codeUpper = countryCode.toUpperCase();</p>
<p class="p1"><span class="Apple-converted-space">      </span>flagFile = countryFlagMap[codeUpper];</p>
<p class="p1"><span class="Apple-converted-space">      </span>console.log('Flag lookup by country code:', codeUpper, '-&gt;', flagFile);</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Fallback to country name</p>
<p class="p1"><span class="Apple-converted-space">    </span>if (!flagFile &amp;&amp; countryName) {</p>
<p class="p1"><span class="Apple-converted-space">      </span>flagFile = countryFlagMap[countryName];</p>
<p class="p1"><span class="Apple-converted-space">      </span>console.log('Flag lookup by country name:', countryName, '-&gt;', flagFile);</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Additional fallback for common country name variations</p>
<p class="p1"><span class="Apple-converted-space">    </span>if (!flagFile &amp;&amp; countryName) {</p>
<p class="p1"><span class="Apple-converted-space">      </span>const nameVariations = {</p>
<p class="p1"><span class="Apple-converted-space">        </span>'United States of America': 'us.svg',</p>
<p class="p1"><span class="Apple-converted-space">        </span>'USA': 'us.svg',</p>
<p class="p1"><span class="Apple-converted-space">        </span>'U.S.A.': 'us.svg',</p>
<p class="p1"><span class="Apple-converted-space">        </span>'America': 'us.svg',</p>
<p class="p1"><span class="Apple-converted-space">        </span>'Great Britain': 'gb.svg',</p>
<p class="p1"><span class="Apple-converted-space">        </span>'UK': 'gb.svg',</p>
<p class="p1"><span class="Apple-converted-space">        </span>'U.K.': 'gb.svg',</p>
<p class="p1"><span class="Apple-converted-space">        </span>'England': 'gb.svg',</p>
<p class="p1"><span class="Apple-converted-space">        </span>'Scotland': 'gb.svg',</p>
<p class="p1"><span class="Apple-converted-space">        </span>'Wales': 'gb.svg',</p>
<p class="p1"><span class="Apple-converted-space">        </span>'Northern Ireland': 'gb.svg',</p>
<p class="p1"><span class="Apple-converted-space">        </span>'South Korea': 'kr.svg',</p>
<p class="p1"><span class="Apple-converted-space">        </span>'Republic of Korea': 'kr.svg',</p>
<p class="p1"><span class="Apple-converted-space">        </span>'North Korea': 'kp.svg',</p>
<p class="p1"><span class="Apple-converted-space">        </span>'Czech Republic': 'cz.svg',</p>
<p class="p1"><span class="Apple-converted-space">        </span>'Czechia': 'cz.svg',</p>
<p class="p1"><span class="Apple-converted-space">        </span>'Vatican': 'va.svg',</p>
<p class="p1"><span class="Apple-converted-space">        </span>'Holy See': 'va.svg',</p>
<p class="p1"><span class="Apple-converted-space">        </span>'The Vatican': 'va.svg',</p>
<p class="p1"><span class="Apple-converted-space">        </span>'Republic of China': 'tw.svg',</p>
<p class="p1"><span class="Apple-converted-space">        </span>'Chinese Taipei': 'tw.svg',</p>
<p class="p1"><span class="Apple-converted-space">        </span>'Hong Kong SAR': 'hk.svg',</p>
<p class="p1"><span class="Apple-converted-space">        </span>'Macao SAR': 'mo.svg',</p>
<p class="p1"><span class="Apple-converted-space">        </span>'Macau': 'mo.svg',</p>
<p class="p1"><span class="Apple-converted-space">        </span>'Democratic Republic of the Congo': 'cd.svg',</p>
<p class="p1"><span class="Apple-converted-space">        </span>'DR Congo': 'cd.svg',</p>
<p class="p1"><span class="Apple-converted-space">        </span>'Republic of the Congo': 'cg.svg',</p>
<p class="p1"><span class="Apple-converted-space">        </span>'Congo': 'cg.svg',</p>
<p class="p1"><span class="Apple-converted-space">        </span>'Ivory Coast': 'ci.svg',</p>
<p class="p1"><span class="Apple-converted-space">        </span>'Côte d\'Ivoire': 'ci.svg'</p>
<p class="p1"><span class="Apple-converted-space">      </span>};</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>flagFile = nameVariations[countryName];</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (flagFile) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>console.log('Flag lookup by name variation:', countryName, '-&gt;', flagFile);</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>if (flagFile) {</p>
<p class="p1"><span class="Apple-converted-space">      </span>return {</p>
<p class="p1"><span class="Apple-converted-space">        </span>primary: repoBaseUrl + flagFile,</p>
<p class="p1"><span class="Apple-converted-space">        </span>hasFlag: true,</p>
<p class="p1"><span class="Apple-converted-space">        </span>country: countryName || countryCode</p>
<p class="p1"><span class="Apple-converted-space">      </span>};</p>
<p class="p1"><span class="Apple-converted-space">    </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">      </span>console.log('No flag found for:', countryName, countryCode);</p>
<p class="p1"><span class="Apple-converted-space">      </span>return {</p>
<p class="p1"><span class="Apple-converted-space">        </span>primary: null,</p>
<p class="p1"><span class="Apple-converted-space">        </span>hasFlag: false,</p>
<p class="p1"><span class="Apple-converted-space">        </span>country: countryName || countryCode</p>
<p class="p1"><span class="Apple-converted-space">      </span>};</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Function to update country flag display</p>
<p class="p1"><span class="Apple-converted-space">  </span>function updateCountryFlag(countryName, countryCode) {</p>
<p class="p1"><span class="Apple-converted-space">    </span>const flagImg = document.getElementById('country-flag');</p>
<p class="p1"><span class="Apple-converted-space">    </span>const fallbackIcon = document.getElementById('location-fallback');</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>if (!flagImg || !fallbackIcon) {</p>
<p class="p1"><span class="Apple-converted-space">      </span>console.log('Flag elements not found:', { flagImg: !!flagImg, fallbackIcon: !!fallbackIcon });</p>
<p class="p1"><span class="Apple-converted-space">      </span>return;</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>const flagInfo = getCountryFlagIcon(countryName, countryCode);</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>if (flagInfo.hasFlag) {</p>
<p class="p1"><span class="Apple-converted-space">      </span>// Hide fallback icon and show flag</p>
<p class="p1"><span class="Apple-converted-space">      </span>fallbackIcon.style.display = 'none';</p>
<p class="p1"><span class="Apple-converted-space">      </span>flagImg.style.display = 'inline-block';</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Set up error handler for flag loading</p>
<p class="p1"><span class="Apple-converted-space">      </span>flagImg.onerror = function() {</p>
<p class="p1"><span class="Apple-converted-space">        </span>console.log('Flag icon failed to load, showing fallback location icon');</p>
<p class="p1"><span class="Apple-converted-space">        </span>console.log('Failed flag URL:', flagInfo.primary);</p>
<p class="p1"><span class="Apple-converted-space">        </span>console.log('Error details:', this.src, this.complete, this.naturalWidth, this.naturalHeight);</p>
<p class="p1"><span class="Apple-converted-space">        </span>flagImg.style.display = 'none';</p>
<p class="p1"><span class="Apple-converted-space">        </span>fallbackIcon.style.display = 'inline-block';</p>
<p class="p1"><span class="Apple-converted-space">      </span>};</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Set up success handler</p>
<p class="p1"><span class="Apple-converted-space">      </span>flagImg.onload = function() {</p>
<p class="p1"><span class="Apple-converted-space">        </span>console.log('Flag icon loaded successfully:', flagInfo.primary);</p>
<p class="p1"><span class="Apple-converted-space">        </span>console.log('Image dimensions:', this.naturalWidth, 'x', this.naturalHeight);</p>
<p class="p1"><span class="Apple-converted-space">        </span>flagImg.style.display = 'inline-block';</p>
<p class="p1"><span class="Apple-converted-space">        </span>fallbackIcon.style.display = 'none';</p>
<p class="p1"><span class="Apple-converted-space">      </span>};</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Set flag source</p>
<p class="p1"><span class="Apple-converted-space">      </span>flagImg.src = flagInfo.primary;</p>
<p class="p1"><span class="Apple-converted-space">      </span>flagImg.alt = `Flag of ${flagInfo.country}`;</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>console.log('<span class="s2">🏁</span> Showing flag for:', flagInfo.country);</p>
<p class="p1"><span class="Apple-converted-space">      </span>console.log('Flag URL:', flagInfo.primary);</p>
<p class="p1"><span class="Apple-converted-space">    </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">      </span>// No flag available, show fallback location icon</p>
<p class="p1"><span class="Apple-converted-space">      </span>flagImg.style.display = 'none';</p>
<p class="p1"><span class="Apple-converted-space">      </span>fallbackIcon.style.display = 'inline-block';</p>
<p class="p1"><span class="Apple-converted-space">      </span>console.log('<span class="s2">📍</span> No flag available, showing location icon for:', countryName || countryCode);</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Test function to manually test flag loading</p>
<p class="p1"><span class="Apple-converted-space">  </span>function testFlag(countryName, countryCode) {</p>
<p class="p1"><span class="Apple-converted-space">    </span>console.log('=== FLAG TEST ===');</p>
<p class="p1"><span class="Apple-converted-space">    </span>console.log('Testing flag for:', countryName, countryCode);</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Test the flag lookup</p>
<p class="p1"><span class="Apple-converted-space">    </span>const flagInfo = getCountryFlagIcon(countryName, countryCode);</p>
<p class="p1"><span class="Apple-converted-space">    </span>console.log('Flag info:', flagInfo);</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Test updating the flag</p>
<p class="p1"><span class="Apple-converted-space">    </span>updateCountryFlag(countryName, countryCode);</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Test direct URL access</p>
<p class="p1"><span class="Apple-converted-space">    </span>if (flagInfo.hasFlag) {</p>
<p class="p1"><span class="Apple-converted-space">      </span>console.log('Testing direct URL access...');</p>
<p class="p1"><span class="Apple-converted-space">      </span>fetch(flagInfo.primary)</p>
<p class="p1"><span class="Apple-converted-space">        </span>.then(response =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">          </span>console.log('URL fetch response:', response.status, response.statusText);</p>
<p class="p1"><span class="Apple-converted-space">          </span>return response.text();</p>
<p class="p1"><span class="Apple-converted-space">        </span>})</p>
<p class="p1"><span class="Apple-converted-space">        </span>.then(text =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">          </span>console.log('Flag file content length:', text.length);</p>
<p class="p1"><span class="Apple-converted-space">          </span>console.log('Flag file preview:', text.substring(0, 200) + '...');</p>
<p class="p1"><span class="Apple-converted-space">        </span>})</p>
<p class="p1"><span class="Apple-converted-space">        </span>.catch(error =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">          </span>console.error('Flag URL fetch error:', error);</p>
<p class="p1"><span class="Apple-converted-space">        </span>});</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Add test function to global scope for debugging</p>
<p class="p1"><span class="Apple-converted-space">  </span>window.testFlag = testFlag;</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>async function fetchWeather(lat, lon){</p>
<p class="p1"><span class="Apple-converted-space">    </span>try {</p>
<p class="p1"><span class="Apple-converted-space">      </span>lastWeatherTimestamp = Date.now(); // Track fetch attempt time</p>
<p class="p1"><span class="Apple-converted-space">      </span>const r = await fetchWithRetry(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&amp;longitude=${lon}&amp;current=temperature_2m,weather_code,is_day,wind_speed_10m,precipitation,visibility&amp;timezone=auto`);</p>
<p class="p1"><span class="Apple-converted-space">      </span>const j = await r.json();</p>
<p class="p1"><span class="Apple-converted-space">      </span>const c = Math.round(j.current.temperature_2m);</p>
<p class="p1"><span class="Apple-converted-space">      </span>const f = Math.round(c * 9 / 5 + 32);</p>
<p class="p1"><span class="Apple-converted-space">      </span>const isDay = j.current.is_day === 1;</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Enhanced weather condition detection using multiple parameters</p>
<p class="p1"><span class="Apple-converted-space">      </span>let weatherInfo = googleWeatherCodes[j.current.weather_code] || { condition: 'CLOUDY', description: 'Cloudy' };</p>
<p class="p1"><span class="Apple-converted-space">      </span>let condition = weatherInfo.condition;</p>
<p class="p1"><span class="Apple-converted-space">      </span>let desc = weatherInfo.description;</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Enhanced condition logic using additional parameters</p>
<p class="p1"><span class="Apple-converted-space">      </span>const windSpeed = j.current.wind_speed_10m || 0;</p>
<p class="p1"><span class="Apple-converted-space">      </span>const precipitation = j.current.precipitation || 0;</p>
<p class="p1"><span class="Apple-converted-space">      </span>const visibility = j.current.visibility || 10000;</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Wind conditions - now as secondary effects only</p>
<p class="p1"><span class="Apple-converted-space">      </span>let isWindy = windSpeed &gt; 18; // Lowered from 20 to 10 km/h</p>
<p class="p1"><span class="Apple-converted-space">      </span>let isVeryWindy = windSpeed &gt; 35; // Lowered from 40 to 25 km/h</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Add debug logging for wind detection</p>
<p class="p1"><span class="Apple-converted-space">      </span>console.log('Wind speed:', windSpeed, 'km/h, isWindy:', isWindy, 'isVeryWindy:', isVeryWindy);</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Don't override main weather condition for wind - keep original condition</p>
<p class="p1"><span class="Apple-converted-space">      </span>// Wind will be shown as secondary effect below</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Visibility-based conditions</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (visibility &lt; 1000) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (j.current.weather_code === 45 || j.current.weather_code === 48) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>// Keep existing fog mapping</p>
<p class="p1"><span class="Apple-converted-space">        </span>} else if (c &lt; 0 &amp;&amp; (j.current.weather_code &gt;= 71 &amp;&amp; j.current.weather_code &lt;= 77)) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>condition = 'BLOWING_SNOW';</p>
<p class="p1"><span class="Apple-converted-space">          </span>desc = 'Blowing Snow';</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Enhanced snow conditions based on intensity and temperature</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (j.current.weather_code &gt;= 71 &amp;&amp; j.current.weather_code &lt;= 77) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (c &lt; -10 &amp;&amp; windSpeed &gt; 30) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>condition = 'BLIZZARD';</p>
<p class="p1"><span class="Apple-converted-space">          </span>desc = 'Blizzard';</p>
<p class="p1"><span class="Apple-converted-space">        </span>} else if (j.current.weather_code === 75 &amp;&amp; windSpeed &gt; 20) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>condition = 'SNOWSTORM';</p>
<p class="p1"><span class="Apple-converted-space">          </span>desc = 'Snowstorm';</p>
<p class="p1"><span class="Apple-converted-space">        </span>} else if (c &lt; -15) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>condition = 'HEAVY_SNOW_STORM';</p>
<p class="p1"><span class="Apple-converted-space">          </span>desc = 'Heavy Snow Storm';</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Enhanced rain conditions</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (j.current.weather_code &gt;= 61 &amp;&amp; j.current.weather_code &lt;= 67) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (j.current.weather_code &lt;= 63) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>condition = 'LIGHT_RAIN';</p>
<p class="p1"><span class="Apple-converted-space">          </span>desc = 'Light Rain';</p>
<p class="p1"><span class="Apple-converted-space">        </span>} else if (j.current.weather_code &gt;= 65) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>condition = 'HEAVY_RAIN';</p>
<p class="p1"><span class="Apple-converted-space">          </span>desc = 'Heavy Rain';</p>
<p class="p1"><span class="Apple-converted-space">        </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">          </span>condition = 'RAIN';</p>
<p class="p1"><span class="Apple-converted-space">          </span>desc = 'Rain';</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Mixed precipitation detection</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (precipitation &gt; 0 &amp;&amp; c &gt;= -2 &amp;&amp; c &lt;= 2) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (j.current.weather_code &gt;= 61 &amp;&amp; j.current.weather_code &lt;= 67) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>condition = 'RAIN_AND_SNOW';</p>
<p class="p1"><span class="Apple-converted-space">          </span>desc = 'Rain and Snow';</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Thunderstorm enhancements</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (j.current.weather_code &gt;= 95 &amp;&amp; j.current.weather_code &lt;= 99) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (windSpeed &gt; 40) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>condition = 'HEAVY_THUNDERSTORM';</p>
<p class="p1"><span class="Apple-converted-space">          </span>desc = 'Severe Thunderstorm';</p>
<p class="p1"><span class="Apple-converted-space">        </span>} else if (windSpeed &gt; 25) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>condition = 'SCATTERED_THUNDERSTORMS';</p>
<p class="p1"><span class="Apple-converted-space">          </span>desc = 'Scattered Thunderstorms';</p>
<p class="p1"><span class="Apple-converted-space">        </span>} else if (precipitation &gt; 0) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>condition = 'THUNDERSHOWER';</p>
<p class="p1"><span class="Apple-converted-space">          </span>desc = 'Thundershower';</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Hail detection for thunderstorms</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (j.current.weather_code &gt;= 96) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>condition = 'HAIL';</p>
<p class="p1"><span class="Apple-converted-space">          </span>desc = j.current.weather_code === 96 ? 'Light Hail' : 'Heavy Hail';</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Temperature-based extreme conditions</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (c &gt; 35) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>condition = 'VERY_HOT';</p>
<p class="p1"><span class="Apple-converted-space">        </span>desc = 'Very Hot';</p>
<p class="p1"><span class="Apple-converted-space">      </span>} else if (c &lt; -20) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>condition = 'VERY_COLD';</p>
<p class="p1"><span class="Apple-converted-space">        </span>desc = 'Very Cold';</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Change "Clear" to "Sunny" if temperature is above 17°C and condition is clear AND it's daytime</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (j.current.weather_code === 0 &amp;&amp; c &gt; 17 &amp;&amp; condition === 'CLEAR' &amp;&amp; isDay) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>desc = 'Sunny';</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Get regional heat wave threshold</p>
<p class="p1"><span class="Apple-converted-space">      </span>const heatThreshold = determineHeatWaveThreshold(lat);</p>
<p class="p1"><span class="Apple-converted-space">      </span>console.log(`Heat wave threshold for region (${heatThreshold.region}): ${heatThreshold.threshold}°C`);</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Check for heat wave conditions</p>
<p class="p1"><span class="Apple-converted-space">      </span>const isHot = c &gt;= heatThreshold.threshold; // Temperature-based only, regionally appropriate</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Add wind description to weather text if windy</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (isVeryWindy) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>desc += ', Very Windy';</p>
<p class="p1"><span class="Apple-converted-space">      </span>} else if (isWindy) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>desc += ', Windy';</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Add heat wave description if applicable</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (isHot) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>desc += ', Heat Wave';</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Cache successful weather data</p>
<p class="p1"><span class="Apple-converted-space">      </span>lastWeatherData = {</p>
<p class="p1"><span class="Apple-converted-space">        </span>temperature: c,</p>
<p class="p1"><span class="Apple-converted-space">        </span>fahrenheit: f,</p>
<p class="p1"><span class="Apple-converted-space">        </span>description: desc,</p>
<p class="p1"><span class="Apple-converted-space">        </span>weatherCode: j.current.weather_code,</p>
<p class="p1"><span class="Apple-converted-space">        </span>isDay: isDay,</p>
<p class="p1"><span class="Apple-converted-space">        </span>isHot: isHot,</p>
<p class="p1"><span class="Apple-converted-space">        </span>isWindy: isWindy,</p>
<p class="p1"><span class="Apple-converted-space">        </span>condition: condition,</p>
<p class="p1"><span class="Apple-converted-space">        </span>lat: lat,</p>
<p class="p1"><span class="Apple-converted-space">        </span>lon: lon</p>
<p class="p1"><span class="Apple-converted-space">      </span>};</p>
<p class="p1"><span class="Apple-converted-space">      </span>lastWeatherTimestamp = Date.now();</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Set final weather text</p>
<p class="p1"><span class="Apple-converted-space">      </span>weatherEl.textContent = `${c}°C | ${f}°F, ${desc}`;</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Update weather icon with enhanced condition</p>
<p class="p1"><span class="Apple-converted-space">      </span>const weatherIcon = document.getElementById('weather-icon');</p>
<p class="p1"><span class="Apple-converted-space">      </span>const iconUrls = getGoogleWeatherIcon(j.current.weather_code, isDay, condition);</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Create new image element and preload it</p>
<p class="p1"><span class="Apple-converted-space">      </span>const imgElement = document.createElement('img');</p>
<p class="p1"><span class="Apple-converted-space">      </span>imgElement.alt = desc;</p>
<p class="p1"><span class="Apple-converted-space">      </span>imgElement.style.cssText = 'width: 24px; height: 24px; filter: drop-shadow(-1px -1px 0 #000) drop-shadow(1px -1px 0 #000) drop-shadow(-1px 1px 0 #000) drop-shadow(1px 1px 0 #000) drop-shadow(0 0 4px #000);';</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Add error handler for fallback to standard Google icons</p>
<p class="p1"><span class="Apple-converted-space">      </span>imgElement.onerror = function() {</p>
<p class="p1"><span class="Apple-converted-space">        </span>console.log('Primary weather icon failed, using fallback:', iconUrls.fallback);</p>
<p class="p1"><span class="Apple-converted-space">        </span>this.src = iconUrls.fallback;</p>
<p class="p1"><span class="Apple-converted-space">      </span>};</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Only replace the icon after the new one has loaded to prevent blinking</p>
<p class="p1"><span class="Apple-converted-space">      </span>imgElement.onload = function() {</p>
<p class="p1"><span class="Apple-converted-space">        </span>// Preserve secondary effects (heat-waves and wind-waves) before clearing</p>
<p class="p1"><span class="Apple-converted-space">        </span>const heatWaves = weatherIcon.querySelector('#heat-waves');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const windWaves = weatherIcon.querySelector('#wind-waves');</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Clear and add new main icon</p>
<p class="p1"><span class="Apple-converted-space">        </span>weatherIcon.innerHTML = '';</p>
<p class="p1"><span class="Apple-converted-space">        </span>weatherIcon.appendChild(imgElement);</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Re-add preserved secondary effects</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (heatWaves) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>weatherIcon.appendChild(heatWaves);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (windWaves) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>weatherIcon.appendChild(windWaves);</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Now handle wind-waves logic after elements are restored</p>
<p class="p1"><span class="Apple-converted-space">        </span>// Show wind waves if windy conditions</p>
<p class="p1"><span class="Apple-converted-space">        </span>const windWavesElement = document.getElementById('wind-waves');</p>
<p class="p1"><span class="Apple-converted-space">        </span>console.log('Wind waves element found:', !!windWavesElement, 'isWindy:', isWindy);</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>if (windWavesElement) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>if (isWindy) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>console.log('Attempting to show wind waves...');</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Load windy.svg icon</p>
<p class="p1"><span class="Apple-converted-space">            </span>const repoBaseUrl = 'https://maps.gstatic.com/weather/v1/';</p>
<p class="p1"><span class="Apple-converted-space">            </span>const fallbackUrl = 'https://maps.gstatic.com/weather/v1/';</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Clear any existing error handlers</p>
<p class="p1"><span class="Apple-converted-space">            </span>windWavesElement.onerror = null;</p>
<p class="p1"><span class="Apple-converted-space">            </span>windWavesElement.onload = null;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Set up error handler first</p>
<p class="p1"><span class="Apple-converted-space">            </span>windWavesElement.onerror = function() {</p>
<p class="p1"><span class="Apple-converted-space">              </span>console.log('Primary wind icon failed, trying fallback...');</p>
<p class="p1"><span class="Apple-converted-space">              </span>this.onerror = function() {</p>
<p class="p1"><span class="Apple-converted-space">                </span>console.log('Fallback wind icon also failed, using text fallback');</p>
<p class="p1"><span class="Apple-converted-space">                </span>// If both icons fail, create a text-based wind indicator</p>
<p class="p1"><span class="Apple-converted-space">                </span>this.style.display = 'none';</p>
<p class="p2"><span class="Apple-converted-space">                </span></p>
<p class="p1"><span class="Apple-converted-space">                </span>// Create a text-based wind indicator as last resort</p>
<p class="p1"><span class="Apple-converted-space">                </span>let textWind = document.getElementById('text-wind-indicator');</p>
<p class="p1"><span class="Apple-converted-space">                </span>if (!textWind) {</p>
<p class="p1"><span class="Apple-converted-space">                  </span>textWind = document.createElement('span');</p>
<p class="p1"><span class="Apple-converted-space">                  </span>textWind.id = 'text-wind-indicator';</p>
<p class="p1"><span class="Apple-converted-space">                  </span>textWind.innerHTML = '<span class="s2">💨</span>';</p>
<p class="p1"><span class="Apple-converted-space">                  </span>textWind.style.cssText = 'position: absolute; top: 30px; left: 97%; transform: translateX(-50%); font-size: 12px; animation: windWave 1.5s ease-in-out infinite;';</p>
<p class="p1"><span class="Apple-converted-space">                  </span>weatherIcon.appendChild(textWind);</p>
<p class="p1"><span class="Apple-converted-space">                </span>}</p>
<p class="p1"><span class="Apple-converted-space">                </span>textWind.style.display = 'inline-block';</p>
<p class="p1"><span class="Apple-converted-space">              </span>};</p>
<p class="p1"><span class="Apple-converted-space">              </span>this.src = fallbackUrl + 'windy_breezy.svg';</p>
<p class="p1"><span class="Apple-converted-space">            </span>};</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Set up success handler</p>
<p class="p1"><span class="Apple-converted-space">            </span>windWavesElement.onload = function() {</p>
<p class="p1"><span class="Apple-converted-space">              </span>console.log('Wind icon loaded successfully');</p>
<p class="p1"><span class="Apple-converted-space">            </span>};</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Set the primary source</p>
<p class="p1"><span class="Apple-converted-space">            </span>windWavesElement.src = repoBaseUrl + 'windy.svg';</p>
<p class="p1"><span class="Apple-converted-space">            </span>windWavesElement.style.display = 'inline-block';</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>console.log('Wind waves display set to inline-block, src:', windWavesElement.src);</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Position wind waves - if no heat, center it; if heat, keep it to the right</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (isHot) {</p>
<p class="p1"><span class="Apple-converted-space">              </span>windWavesElement.classList.remove('only-wind');</p>
<p class="p1"><span class="Apple-converted-space">              </span>console.log('Wind waves positioned with heat waves');</p>
<p class="p1"><span class="Apple-converted-space">              </span>// Update heat waves to show they're with wind</p>
<p class="p1"><span class="Apple-converted-space">              </span>if (heatWaves) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>heatWaves.classList.add('with-wind');</p>
<p class="p1"><span class="Apple-converted-space">              </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">              </span>windWavesElement.classList.add('only-wind');</p>
<p class="p1"><span class="Apple-converted-space">              </span>console.log('Wind waves positioned alone (only-wind)');</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">          </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">            </span>console.log('Not windy enough, hiding wind waves');</p>
<p class="p1"><span class="Apple-converted-space">            </span>windWavesElement.style.display = 'none';</p>
<p class="p1"><span class="Apple-converted-space">            </span>windWavesElement.classList.remove('only-wind');</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Also hide text wind indicator if it exists</p>
<p class="p1"><span class="Apple-converted-space">            </span>const textWind = document.getElementById('text-wind-indicator');</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (textWind) {</p>
<p class="p1"><span class="Apple-converted-space">              </span>textWind.style.display = 'none';</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Remove wind class from heat waves</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (heatWaves) {</p>
<p class="p1"><span class="Apple-converted-space">              </span>heatWaves.classList.remove('with-wind');</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">          </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">          </span>console.warn('Wind waves element not found after restoration');</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>};</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Start loading the image (this triggers the onload event when ready)</p>
<p class="p1"><span class="Apple-converted-space">      </span>imgElement.src = iconUrls.primary;</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Show heat waves based on regional threshold (no wind requirement)</p>
<p class="p1"><span class="Apple-converted-space">      </span>const heatWaves = document.getElementById('heat-waves');</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (heatWaves) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (isHot) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>heatWaves.style.display = 'inline-block';</p>
<p class="p1"><span class="Apple-converted-space">          </span>// Position based on whether wind is also showing</p>
<p class="p1"><span class="Apple-converted-space">          </span>if (isWindy) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>heatWaves.classList.add('with-wind');</p>
<p class="p1"><span class="Apple-converted-space">          </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">            </span>heatWaves.classList.remove('with-wind');</p>
<p class="p1"><span class="Apple-converted-space">          </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">          </span>heatWaves.style.display = 'none';</p>
<p class="p1"><span class="Apple-converted-space">          </span>heatWaves.classList.remove('with-wind');</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>} catch (error) {</p>
<p class="p1"><span class="Apple-converted-space">      </span>console.error('Weather fetch failed:', error);</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Use cached weather data instead of showing "Weather N/A" (persistent like location caching)</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (lastWeatherData) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>console.log('Using cached weather data due to fetch failure');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const cached = lastWeatherData;</p>
<p class="p1"><span class="Apple-converted-space">        </span>weatherEl.textContent = `${cached.temperature}°C | ${cached.fahrenheit}°F, ${cached.description}`;</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Update weather icon with cached condition</p>
<p class="p1"><span class="Apple-converted-space">        </span>const weatherIcon = document.getElementById('weather-icon');</p>
<p class="p1"><span class="Apple-converted-space">        </span>const iconUrls = getGoogleWeatherIcon(cached.weatherCode, cached.isDay, cached.condition);</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Create new image element for cached data</p>
<p class="p1"><span class="Apple-converted-space">        </span>const imgElement = document.createElement('img');</p>
<p class="p1"><span class="Apple-converted-space">        </span>imgElement.alt = cached.description;</p>
<p class="p1"><span class="Apple-converted-space">        </span>imgElement.style.cssText = 'width: 24px; height: 24px; filter: drop-shadow(-1px -1px 0 #000) drop-shadow(1px -1px 0 #000) drop-shadow(-1px 1px 0 #000) drop-shadow(1px 1px 0 #000) drop-shadow(0 0 4px #000);';</p>
<p class="p1"><span class="Apple-converted-space">        </span>imgElement.src = iconUrls.primary;</p>
<p class="p1"><span class="Apple-converted-space">        </span>imgElement.onerror = function() { this.src = iconUrls.fallback; };</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Use proper element restoration for cached data</p>
<p class="p1"><span class="Apple-converted-space">        </span>imgElement.onload = function() {</p>
<p class="p1"><span class="Apple-converted-space">          </span>// Preserve secondary effects before clearing</p>
<p class="p1"><span class="Apple-converted-space">          </span>const heatWaves = weatherIcon.querySelector('#heat-waves');</p>
<p class="p1"><span class="Apple-converted-space">          </span>const windWaves = weatherIcon.querySelector('#wind-waves');</p>
<p class="p2"><span class="Apple-converted-space">          </span></p>
<p class="p1"><span class="Apple-converted-space">          </span>// Update icon</p>
<p class="p1"><span class="Apple-converted-space">          </span>weatherIcon.innerHTML = '';</p>
<p class="p1"><span class="Apple-converted-space">          </span>weatherIcon.appendChild(imgElement);</p>
<p class="p2"><span class="Apple-converted-space">          </span></p>
<p class="p1"><span class="Apple-converted-space">          </span>// Re-add preserved secondary effects</p>
<p class="p1"><span class="Apple-converted-space">          </span>if (heatWaves) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>weatherIcon.appendChild(heatWaves);</p>
<p class="p1"><span class="Apple-converted-space">          </span>}</p>
<p class="p1"><span class="Apple-converted-space">          </span>if (windWaves) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>weatherIcon.appendChild(windWaves);</p>
<p class="p1"><span class="Apple-converted-space">          </span>}</p>
<p class="p2"><span class="Apple-converted-space">          </span></p>
<p class="p1"><span class="Apple-converted-space">          </span>// Update secondary effects with cached data after elements are restored</p>
<p class="p1"><span class="Apple-converted-space">          </span>const restoredHeatWaves = document.getElementById('heat-waves');</p>
<p class="p1"><span class="Apple-converted-space">          </span>const restoredWindWaves = document.getElementById('wind-waves');</p>
<p class="p2"><span class="Apple-converted-space">          </span></p>
<p class="p1"><span class="Apple-converted-space">          </span>if (restoredHeatWaves) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>restoredHeatWaves.style.display = cached.isHot ? 'inline-block' : 'none';</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (cached.isHot &amp;&amp; cached.isWindy) {</p>
<p class="p1"><span class="Apple-converted-space">              </span>restoredHeatWaves.classList.add('with-wind');</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">              </span>restoredHeatWaves.classList.remove('with-wind');</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">          </span>}</p>
<p class="p2"><span class="Apple-converted-space">          </span></p>
<p class="p1"><span class="Apple-converted-space">          </span>if (restoredWindWaves) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>restoredWindWaves.style.display = cached.isWindy ? 'inline-block' : 'none';</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (cached.isWindy) {</p>
<p class="p1"><span class="Apple-converted-space">              </span>if (cached.isHot) {</p>
<p class="p1"><span class="Apple-converted-space">                </span>restoredWindWaves.classList.remove('only-wind');</p>
<p class="p1"><span class="Apple-converted-space">              </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">                </span>restoredWindWaves.classList.add('only-wind');</p>
<p class="p1"><span class="Apple-converted-space">              </span>}</p>
<p class="p1"><span class="Apple-converted-space">            </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">              </span>restoredWindWaves.classList.remove('only-wind');</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">          </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>};</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Start loading the cached weather icon</p>
<p class="p1"><span class="Apple-converted-space">        </span>imgElement.src = iconUrls.primary;</p>
<p class="p1"><span class="Apple-converted-space">      </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">        </span>// Only show "Weather N/A" if no cached data is available at all</p>
<p class="p1"><span class="Apple-converted-space">        </span>weatherEl.textContent = "Weather N/A";</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Method 1: Try IRL Pro location data</p>
<p class="p1"><span class="Apple-converted-space">  </span>function getIRLProLocation() {</p>
<p class="p1"><span class="Apple-converted-space">    </span>if (window.locationData &amp;&amp; window.locationData.latitude &amp;&amp; window.locationData.longitude) {</p>
<p class="p1"><span class="Apple-converted-space">      </span>return {</p>
<p class="p1"><span class="Apple-converted-space">        </span>lat: window.locationData.latitude,</p>
<p class="p1"><span class="Apple-converted-space">        </span>lon: window.locationData.longitude,</p>
<p class="p1"><span class="Apple-converted-space">        </span>source: "IRL Pro GPS"</p>
<p class="p1"><span class="Apple-converted-space">      </span>};</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>return null;</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Method 2: Try browser GPS</p>
<p class="p1"><span class="Apple-converted-space">  </span>function getBrowserGPS(showLoadingMessages = true) {</p>
<p class="p1"><span class="Apple-converted-space">    </span>return new Promise((resolve, reject) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (!navigator.geolocation) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>reject(new Error('Geolocation not supported'));</p>
<p class="p1"><span class="Apple-converted-space">        </span>return;</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>if (showLoadingMessages) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>placeEl.textContent = "Grabbing GPS Location...";</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>const options = {</p>
<p class="p1"><span class="Apple-converted-space">        </span>enableHighAccuracy: true,</p>
<p class="p1"><span class="Apple-converted-space">        </span>timeout: isIOS ? 60000 : (isMobile ? 45000 : 15000),</p>
<p class="p1"><span class="Apple-converted-space">        </span>maximumAge: gpsSuccessful ? 30000 : 0</p>
<p class="p1"><span class="Apple-converted-space">      </span>};</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>navigator.geolocation.getCurrentPosition(</p>
<p class="p1"><span class="Apple-converted-space">        </span>(position) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">          </span>gpsSuccessful = true;</p>
<p class="p1"><span class="Apple-converted-space">          </span>consecutiveGPSFailures = 0;</p>
<p class="p1"><span class="Apple-converted-space">          </span>resolve({</p>
<p class="p1"><span class="Apple-converted-space">            </span>lat: position.coords.latitude,</p>
<p class="p1"><span class="Apple-converted-space">            </span>lon: position.coords.longitude,</p>
<p class="p1"><span class="Apple-converted-space">            </span>accuracy: Math.round(position.coords.accuracy),</p>
<p class="p1"><span class="Apple-converted-space">            </span>source: `GPS (±${Math.round(position.coords.accuracy)}m)`</p>
<p class="p1"><span class="Apple-converted-space">          </span>});</p>
<p class="p1"><span class="Apple-converted-space">        </span>},</p>
<p class="p1"><span class="Apple-converted-space">        </span>(error) =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">          </span>consecutiveGPSFailures++;</p>
<p class="p1"><span class="Apple-converted-space">          </span>reject(error);</p>
<p class="p1"><span class="Apple-converted-space">        </span>},</p>
<p class="p1"><span class="Apple-converted-space">        </span>options</p>
<p class="p1"><span class="Apple-converted-space">      </span>);</p>
<p class="p1"><span class="Apple-converted-space">    </span>});</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>async function updateLocationAndWeather(showLoadingMessages = true){</p>
<p class="p1"><span class="Apple-converted-space">    </span>try {</p>
<p class="p1"><span class="Apple-converted-space">      </span>let locationData = null;</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Try Method 1: IRL Pro location data</p>
<p class="p1"><span class="Apple-converted-space">      </span>locationData = getIRLProLocation();</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Try Method 2: Browser GPS - Allow retries even after previous failures</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (!locationData) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>try {</p>
<p class="p1"><span class="Apple-converted-space">          </span>locationData = await getBrowserGPS(showLoadingMessages);</p>
<p class="p1"><span class="Apple-converted-space">          </span>gpsAttempted = true;</p>
<p class="p1"><span class="Apple-converted-space">        </span>} catch (gpsError) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>console.warn('GPS failed:', gpsError);</p>
<p class="p1"><span class="Apple-converted-space">          </span>gpsAttempted = true;</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Use last known GPS location as fallback (expanded conditions)</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (!locationData &amp;&amp; lastKnownGPSLocation) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>const now = Date.now();</p>
<p class="p1"><span class="Apple-converted-space">        </span>const locationAge = now - (lastKnownGPSLocation.timestamp || 0);</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Use shorter cache time if GPS is working well (more responsive to location changes)</p>
<p class="p1"><span class="Apple-converted-space">        </span>const maxCacheAge = gpsSuccessful ? 300000 : 600000; // 5 minutes if GPS works, 10 minutes otherwise</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Use cached GPS location if it's recent</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (locationAge &lt; maxCacheAge) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>locationData = lastKnownGPSLocation;</p>
<p class="p1"><span class="Apple-converted-space">          </span>console.log('Using cached GPS location (age:', Math.round(locationAge/60000), 'minutes, GPS successful:', gpsSuccessful, ')');</p>
<p class="p1"><span class="Apple-converted-space">        </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">          </span>console.log('Cached GPS location expired (age:', Math.round(locationAge/60000), 'minutes, max:', Math.round(maxCacheAge/60000), 'minutes)');</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">      </span>// Update the display</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (locationData) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>// Check if this is a significantly different location (more than ~1km away)</p>
<p class="p1"><span class="Apple-converted-space">        </span>let isSignificantMove = false;</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (lastKnownGPSLocation &amp;&amp; lastKnownGPSLocation.lat &amp;&amp; lastKnownGPSLocation.lon) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>const latDiff = Math.abs(locationData.lat - lastKnownGPSLocation.lat);</p>
<p class="p1"><span class="Apple-converted-space">          </span>const lonDiff = Math.abs(locationData.lon - lastKnownGPSLocation.lon);</p>
<p class="p1"><span class="Apple-converted-space">          </span>const approximateDistance = Math.sqrt(latDiff * latDiff + lonDiff * lonDiff) * 111000; // Rough conversion to meters</p>
<p class="p2"><span class="Apple-converted-space">          </span></p>
<p class="p1"><span class="Apple-converted-space">          </span>if (approximateDistance &gt; 1000) { // More than 1km</p>
<p class="p1"><span class="Apple-converted-space">            </span>isSignificantMove = true;</p>
<p class="p1"><span class="Apple-converted-space">            </span>console.log('<span class="s2">🚗</span> Significant location change detected! Distance:', Math.round(approximateDistance), 'meters');</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Clear location name cache when we detect a significant move</p>
<p class="p1"><span class="Apple-converted-space">            </span>lastLocationName = null;</p>
<p class="p1"><span class="Apple-converted-space">            </span>lastLocationTimestamp = 0;</p>
<p class="p1"><span class="Apple-converted-space">          </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Only save GPS locations to cache (not IRL Pro data)</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (locationData.source.includes('GPS')) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>lastKnownGPSLocation = locationData;</p>
<p class="p1"><span class="Apple-converted-space">          </span>lastKnownGPSLocation.timestamp = Date.now();</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>if (showLoadingMessages) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>placeEl.textContent = "Loading location...";</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>try {</p>
<p class="p1"><span class="Apple-converted-space">          </span>const label = await reverseGeocode(locationData.lat, locationData.lon);</p>
<p class="p1"><span class="Apple-converted-space">          </span>placeEl.textContent = label;</p>
<p class="p2"><span class="Apple-converted-space">          </span></p>
<p class="p1"><span class="Apple-converted-space">          </span>// Cache successful location name</p>
<p class="p1"><span class="Apple-converted-space">          </span>lastLocationName = label;</p>
<p class="p1"><span class="Apple-converted-space">          </span>lastLocationTimestamp = Date.now();</p>
<p class="p2"><span class="Apple-converted-space">          </span></p>
<p class="p1"><span class="Apple-converted-space">          </span>// Update country flag after successful geocoding</p>
<p class="p1"><span class="Apple-converted-space">          </span>updateCountryFlag(window.currentCountryName, window.currentCountryCode);</p>
<p class="p2"><span class="Apple-converted-space">          </span></p>
<p class="p1"><span class="Apple-converted-space">          </span>console.log('Location updated:', locationData.source, label);</p>
<p class="p1"><span class="Apple-converted-space">        </span>} catch (geocodeError) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>console.error('Geocoding failed:', geocodeError);</p>
<p class="p2"><span class="Apple-converted-space">          </span></p>
<p class="p1"><span class="Apple-converted-space">          </span>// Use cached location name if available</p>
<p class="p1"><span class="Apple-converted-space">          </span>if (lastLocationName) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>console.log('Using cached location name due to geocoding failure');</p>
<p class="p1"><span class="Apple-converted-space">            </span>placeEl.textContent = lastLocationName;</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Try to use cached country info for flag if available</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (window.currentCountryName || window.currentCountryCode) {</p>
<p class="p1"><span class="Apple-converted-space">              </span>updateCountryFlag(window.currentCountryName, window.currentCountryCode);</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">          </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">            </span>// Only show "Location N/A" if no cached name is available</p>
<p class="p1"><span class="Apple-converted-space">            </span>placeEl.textContent = "Location N/A";</p>
<p class="p2"><span class="Apple-converted-space">            </span></p>
<p class="p1"><span class="Apple-converted-space">            </span>// Show fallback location icon when no location data</p>
<p class="p1"><span class="Apple-converted-space">            </span>const flagImg = document.getElementById('country-flag');</p>
<p class="p1"><span class="Apple-converted-space">            </span>const fallbackIcon = document.getElementById('location-fallback');</p>
<p class="p1"><span class="Apple-converted-space">            </span>if (flagImg &amp;&amp; fallbackIcon) {</p>
<p class="p1"><span class="Apple-converted-space">              </span>flagImg.style.display = 'none';</p>
<p class="p1"><span class="Apple-converted-space">              </span>fallbackIcon.style.display = 'inline-block';</p>
<p class="p1"><span class="Apple-converted-space">            </span>}</p>
<p class="p1"><span class="Apple-converted-space">          </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Always try to fetch weather regardless of geocoding success</p>
<p class="p1"><span class="Apple-converted-space">        </span>fetchWeather(locationData.lat, locationData.lon);</p>
<p class="p1"><span class="Apple-converted-space">      </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">        </span>// During silent refreshes, don't immediately show "GPS N/A" - keep existing display</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (showLoadingMessages) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>// Only show "GPS N/A" during initial load or user-initiated refresh</p>
<p class="p1"><span class="Apple-converted-space">          </span>console.error('No GPS data available from any source');</p>
<p class="p1"><span class="Apple-converted-space">          </span>placeEl.textContent = "GPS N/A";</p>
<p class="p2"><span class="Apple-converted-space">          </span></p>
<p class="p1"><span class="Apple-converted-space">          </span>// Show fallback location icon when no location data</p>
<p class="p1"><span class="Apple-converted-space">          </span>const flagImg = document.getElementById('country-flag');</p>
<p class="p1"><span class="Apple-converted-space">          </span>const fallbackIcon = document.getElementById('location-fallback');</p>
<p class="p1"><span class="Apple-converted-space">          </span>if (flagImg &amp;&amp; fallbackIcon) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>flagImg.style.display = 'none';</p>
<p class="p1"><span class="Apple-converted-space">            </span>fallbackIcon.style.display = 'inline-block';</p>
<p class="p1"><span class="Apple-converted-space">          </span>}</p>
<p class="p2"><span class="Apple-converted-space">          </span></p>
<p class="p1"><span class="Apple-converted-space">          </span>// Don't immediately clear weather - let the weather fetch handle caching</p>
<p class="p1"><span class="Apple-converted-space">          </span>if (!lastWeatherData) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>weatherEl.textContent = "Weather N/A";</p>
<p class="p1"><span class="Apple-converted-space">          </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">          </span>// During silent refresh failures, just log the issue but keep existing display</p>
<p class="p1"><span class="Apple-converted-space">          </span>console.log('Silent location refresh failed, keeping existing display');</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p2"><span class="Apple-converted-space">      </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>} catch (e) {</p>
<p class="p1"><span class="Apple-converted-space">      </span>console.error('Location update failed:', e);</p>
<p class="p1"><span class="Apple-converted-space">      </span>// Only show error during initial load or user-initiated refresh</p>
<p class="p1"><span class="Apple-converted-space">      </span>if (showLoadingMessages) {</p>
<p class="p1"><span class="Apple-converted-space">        </span>// Use cached location name if available, even during errors</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (lastLocationName) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>console.log('Using cached location name due to update failure');</p>
<p class="p1"><span class="Apple-converted-space">          </span>placeEl.textContent = lastLocationName;</p>
<p class="p2"><span class="Apple-converted-space">          </span></p>
<p class="p1"><span class="Apple-converted-space">          </span>// Try to use cached country info for flag if available</p>
<p class="p1"><span class="Apple-converted-space">          </span>if (window.currentCountryName || window.currentCountryCode) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>updateCountryFlag(window.currentCountryName, window.currentCountryCode);</p>
<p class="p1"><span class="Apple-converted-space">          </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>} else {</p>
<p class="p1"><span class="Apple-converted-space">          </span>// Only show "GPS N/A" if no cached name is available</p>
<p class="p1"><span class="Apple-converted-space">          </span>placeEl.textContent = "GPS N/A";</p>
<p class="p2"><span class="Apple-converted-space">          </span></p>
<p class="p1"><span class="Apple-converted-space">          </span>// Show fallback location icon when no location data</p>
<p class="p1"><span class="Apple-converted-space">          </span>const flagImg = document.getElementById('country-flag');</p>
<p class="p1"><span class="Apple-converted-space">          </span>const fallbackIcon = document.getElementById('location-fallback');</p>
<p class="p1"><span class="Apple-converted-space">          </span>if (flagImg &amp;&amp; fallbackIcon) {</p>
<p class="p1"><span class="Apple-converted-space">            </span>flagImg.style.display = 'none';</p>
<p class="p1"><span class="Apple-converted-space">            </span>fallbackIcon.style.display = 'inline-block';</p>
<p class="p1"><span class="Apple-converted-space">          </span>}</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p2"><span class="Apple-converted-space">        </span></p>
<p class="p1"><span class="Apple-converted-space">        </span>// Don't immediately clear weather - let cached data persist</p>
<p class="p1"><span class="Apple-converted-space">        </span>if (!lastWeatherData) {</p>
<p class="p1"><span class="Apple-converted-space">          </span>weatherEl.textContent = "Weather N/A";</p>
<p class="p1"><span class="Apple-converted-space">        </span>}</p>
<p class="p1"><span class="Apple-converted-space">      </span>}</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Network state change handlers</p>
<p class="p1"><span class="Apple-converted-space">  </span>function handleOnline() {</p>
<p class="p1"><span class="Apple-converted-space">    </span>console.log('Connection restored, attempting immediate update...');</p>
<p class="p1"><span class="Apple-converted-space">    </span>isOnline = true;</p>
<p class="p1"><span class="Apple-converted-space">    </span>hasConnectionIssues = false;</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Clear any pending retry timeouts</p>
<p class="p1"><span class="Apple-converted-space">    </span>retryTimeouts.forEach(clearTimeout);</p>
<p class="p1"><span class="Apple-converted-space">    </span>retryTimeouts = [];</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Immediately attempt to update location and weather</p>
<p class="p1"><span class="Apple-converted-space">    </span>updateLocationAndWeather(false);</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>function handleOffline() {</p>
<p class="p1"><span class="Apple-converted-space">    </span>console.log('Connection lost, will retry when restored...');</p>
<p class="p1"><span class="Apple-converted-space">    </span>isOnline = false;</p>
<p class="p1"><span class="Apple-converted-space">    </span>hasConnectionIssues = true;</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Listen for online/offline events</p>
<p class="p1"><span class="Apple-converted-space">  </span>window.addEventListener('online', handleOnline);</p>
<p class="p1"><span class="Apple-converted-space">  </span>window.addEventListener('offline', handleOffline);</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Auto-refresh every 55 seconds (without loading messages)</p>
<p class="p1"><span class="Apple-converted-space">  </span>setInterval(() =&gt; updateLocationAndWeather(false), 55000);</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Additional more frequent check during connection issues</p>
<p class="p1"><span class="Apple-converted-space">  </span>setInterval(() =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">    </span>if (hasConnectionIssues &amp;&amp; navigator.onLine) {</p>
<p class="p1"><span class="Apple-converted-space">      </span>console.log('Connection issue detected, attempting recovery update...');</p>
<p class="p1"><span class="Apple-converted-space">      </span>updateLocationAndWeather(false);</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>}, 15000); // Check every 15 seconds during issues</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Function to clear all location caches and force refresh</p>
<p class="p1"><span class="Apple-converted-space">  </span>function clearLocationCache() {</p>
<p class="p1"><span class="Apple-converted-space">    </span>console.log('<span class="s2">🔄</span> Clearing all location caches...');</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Clear all cached location data</p>
<p class="p1"><span class="Apple-converted-space">    </span>lastKnownGPSLocation = null;</p>
<p class="p1"><span class="Apple-converted-space">    </span>lastLocationName = null;</p>
<p class="p1"><span class="Apple-converted-space">    </span>lastLocationTimestamp = 0;</p>
<p class="p1"><span class="Apple-converted-space">    </span>lastWeatherData = null;</p>
<p class="p1"><span class="Apple-converted-space">    </span>lastWeatherTimestamp = 0;</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Clear country information for flag display</p>
<p class="p1"><span class="Apple-converted-space">    </span>window.currentCountryName = null;</p>
<p class="p1"><span class="Apple-converted-space">    </span>window.currentCountryCode = null;</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Reset GPS state to allow fresh attempts</p>
<p class="p1"><span class="Apple-converted-space">    </span>gpsSuccessful = false;</p>
<p class="p1"><span class="Apple-converted-space">    </span>gpsAttempted = false;</p>
<p class="p1"><span class="Apple-converted-space">    </span>consecutiveGPSFailures = 0;</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Reset connection retry state</p>
<p class="p1"><span class="Apple-converted-space">    </span>retryAttempts = 0;</p>
<p class="p1"><span class="Apple-converted-space">    </span>hasConnectionIssues = false;</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Clear any pending timeouts</p>
<p class="p1"><span class="Apple-converted-space">    </span>retryTimeouts.forEach(clearTimeout);</p>
<p class="p1"><span class="Apple-converted-space">    </span>retryTimeouts = [];</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>console.log('<span class="s2">✅</span> All caches cleared! Forcing fresh location update...');</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Force immediate location update with loading messages</p>
<p class="p1"><span class="Apple-converted-space">    </span>placeEl.textContent = "<span class="s2">🔄</span> Refreshing location...";</p>
<p class="p1"><span class="Apple-converted-space">    </span>weatherEl.textContent = "Loading...";</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Show fallback location icon during refresh</p>
<p class="p1"><span class="Apple-converted-space">    </span>const flagImg = document.getElementById('country-flag');</p>
<p class="p1"><span class="Apple-converted-space">    </span>const fallbackIcon = document.getElementById('location-fallback');</p>
<p class="p1"><span class="Apple-converted-space">    </span>if (flagImg &amp;&amp; fallbackIcon) {</p>
<p class="p1"><span class="Apple-converted-space">      </span>flagImg.style.display = 'none';</p>
<p class="p1"><span class="Apple-converted-space">      </span>fallbackIcon.style.display = 'inline-block';</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Small delay to show the refreshing message</p>
<p class="p1"><span class="Apple-converted-space">    </span>setTimeout(() =&gt; {</p>
<p class="p1"><span class="Apple-converted-space">      </span>updateLocationAndWeather(true);</p>
<p class="p1"><span class="Apple-converted-space">    </span>}, 100);</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Function to force location refresh (less aggressive than clearing cache)</p>
<p class="p1"><span class="Apple-converted-space">  </span>function forceLocationRefresh() {</p>
<p class="p1"><span class="Apple-converted-space">    </span>console.log('<span class="s2">🔄</span> Forcing location refresh...');</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Expire current location cache to force new lookup</p>
<p class="p1"><span class="Apple-converted-space">    </span>if (lastKnownGPSLocation) {</p>
<p class="p1"><span class="Apple-converted-space">      </span>lastKnownGPSLocation.timestamp = Date.now() - 700000; // Make it older than 10 minutes</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Reset GPS state to allow fresh attempts</p>
<p class="p1"><span class="Apple-converted-space">    </span>gpsAttempted = false;</p>
<p class="p1"><span class="Apple-converted-space">    </span>consecutiveGPSFailures = 0;</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>placeEl.textContent = "<span class="s2">🔄</span> Updating location...";</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Show fallback location icon during refresh</p>
<p class="p1"><span class="Apple-converted-space">    </span>const flagImg = document.getElementById('country-flag');</p>
<p class="p1"><span class="Apple-converted-space">    </span>const fallbackIcon = document.getElementById('location-fallback');</p>
<p class="p1"><span class="Apple-converted-space">    </span>if (flagImg &amp;&amp; fallbackIcon) {</p>
<p class="p1"><span class="Apple-converted-space">      </span>flagImg.style.display = 'none';</p>
<p class="p1"><span class="Apple-converted-space">      </span>fallbackIcon.style.display = 'inline-block';</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>updateLocationAndWeather(true);</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Keyboard shortcuts for manual refresh</p>
<p class="p1"><span class="Apple-converted-space">  </span>document.addEventListener('keydown', function(event) {</p>
<p class="p1"><span class="Apple-converted-space">    </span>// Ctrl+R or F5 = Force location refresh</p>
<p class="p1"><span class="Apple-converted-space">    </span>if ((event.ctrlKey &amp;&amp; event.key === 'r') || event.key === 'F5') {</p>
<p class="p1"><span class="Apple-converted-space">      </span>event.preventDefault();</p>
<p class="p1"><span class="Apple-converted-space">      </span>console.log('<span class="s2">🔄</span> Manual location refresh triggered by keyboard shortcut');</p>
<p class="p1"><span class="Apple-converted-space">      </span>forceLocationRefresh();</p>
<p class="p1"><span class="Apple-converted-space">      </span>return false;</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p2"><span class="Apple-converted-space">    </span></p>
<p class="p1"><span class="Apple-converted-space">    </span>// Ctrl+Shift+R = Clear all caches and refresh</p>
<p class="p1"><span class="Apple-converted-space">    </span>if (event.ctrlKey &amp;&amp; event.shiftKey &amp;&amp; event.key === 'R') {</p>
<p class="p1"><span class="Apple-converted-space">      </span>event.preventDefault();</p>
<p class="p1"><span class="Apple-converted-space">      </span>console.log('<span class="s2">🔄</span> Manual cache clear triggered by keyboard shortcut');</p>
<p class="p1"><span class="Apple-converted-space">      </span>clearLocationCache();</p>
<p class="p1"><span class="Apple-converted-space">      </span>return false;</p>
<p class="p1"><span class="Apple-converted-space">    </span>}</p>
<p class="p1"><span class="Apple-converted-space">  </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Double-click on location text to force refresh</p>
<p class="p1"><span class="Apple-converted-space">  </span>placeEl.addEventListener('dblclick', function() {</p>
<p class="p1"><span class="Apple-converted-space">    </span>console.log('<span class="s2">🔄</span> Manual location refresh triggered by double-click');</p>
<p class="p1"><span class="Apple-converted-space">    </span>forceLocationRefresh();</p>
<p class="p1"><span class="Apple-converted-space">  </span>});</p>
<p class="p2"><br></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Make functions available globally</p>
<p class="p1"><span class="Apple-converted-space">  </span>window.clearLocationCache = clearLocationCache;</p>
<p class="p1"><span class="Apple-converted-space">  </span>window.forceLocationRefresh = forceLocationRefresh;</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Add visual feedback that double-click is available</p>
<p class="p1"><span class="Apple-converted-space">  </span>placeEl.title = "Double-click to refresh location • Ctrl+R to force refresh • Ctrl+Shift+R to clear cache";</p>
<p class="p1"><span class="Apple-converted-space">  </span>placeEl.style.cursor = "pointer";</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Add subtle hover effect to show it's interactive</p>
<p class="p1"><span class="Apple-converted-space">  </span>placeEl.addEventListener('mouseenter', function() {</p>
<p class="p1"><span class="Apple-converted-space">    </span>this.style.opacity = '0.8';</p>
<p class="p1"><span class="Apple-converted-space">  </span>});</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>placeEl.addEventListener('mouseleave', function() {</p>
<p class="p1"><span class="Apple-converted-space">    </span>this.style.opacity = '1';</p>
<p class="p1"><span class="Apple-converted-space">  </span>});</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Initialize with fallback location icon</p>
<p class="p1"><span class="Apple-converted-space">  </span>const flagImg = document.getElementById('country-flag');</p>
<p class="p1"><span class="Apple-converted-space">  </span>const fallbackIcon = document.getElementById('location-fallback');</p>
<p class="p1"><span class="Apple-converted-space">  </span>if (flagImg &amp;&amp; fallbackIcon) {</p>
<p class="p1"><span class="Apple-converted-space">    </span>flagImg.style.display = 'none';</p>
<p class="p1"><span class="Apple-converted-space">    </span>fallbackIcon.style.display = 'inline-block';</p>
<p class="p1"><span class="Apple-converted-space">  </span>}</p>
<p class="p2"><span class="Apple-converted-space">  </span></p>
<p class="p1"><span class="Apple-converted-space">  </span>// Start immediately (with loading messages)</p>
<p class="p1"><span class="Apple-converted-space">  </span>updateLocationAndWeather(true);</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;/script&gt;</p>
<p class="p1"><span class="Apple-converted-space">  </span>&lt;/body&gt;&lt;/html&gt;</p>
</body>
</html>
